<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AION - AI Music & Video</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script type="module">
        // Firebase SDK v11.6.1 (Modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, increment, writeBatch, collectionGroup, getDocs, Timestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // --- Global Firebase & App Variables ---
        let db, auth, functions;
        let userId = null;
        let isAdminMode = false;
        let appInitialized = false;

        const ADMIN_UID = "THIS_IS_NOT_AN_ADMIN_UID_FOR_USER_VERSION";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aion-admin-app'; // 관리자 기본값과 일치
        console.log("Using appId (User):", appId);

        let firebaseConfig = {
            apiKey: "AIzaSyCAfrCXrHfYWUrvZ-SKqocCXu5QNCbFRH8",
            authDomain: "aion-18c27.firebaseapp.com",
            databaseURL: "https://aion-18c27-default-rtdb.firebaseio.com",
            projectId: "aion-18c27",
            storageBucket: "aion-18c27.appspot.com",
            messagingSenderId: "496946227122",
            appId: "1:496946227122:web:3c7efdd7d014743f3126ab",
            measurementId: "G-K2F99M91CM"
        };

        if (typeof __firebase_config !== 'undefined') {
            try {
                const parsedConfig = JSON.parse(__firebase_config);
                firebaseConfig = { ...firebaseConfig, ...parsedConfig };
                console.log("Using provided Firebase config (User):", firebaseConfig);
            } catch (e) {
                console.error("Error parsing __firebase_config (User):", e);
                showToast("Firebase 설정 오류가 발생했습니다.", true);
            }
        } else {
            console.warn("Global __firebase_config not found. Using hardcoded Firebase config. (User)");
        }

        const firebaseApp = initializeApp(firebaseConfig);
        db = getFirestore(firebaseApp);
        auth = getAuth(firebaseApp);
        functions = getFunctions(firebaseApp);

        setPersistence(auth, browserLocalPersistence);

        const getContentItemsCollectionPath = () => `/artifacts/${appId}/public/data/contentItems`;
        const getUserPlaylistsCollectionPath = (currentUserId) => `/artifacts/${appId}/users/${currentUserId}/playlists`;
        const getUserLikedItemsCollectionPath = (currentUserId) => `/artifacts/${appId}/users/${currentUserId}/likedItems`;
        const getUserSubscribedArtistsCollectionPath = (currentUserId) => `/artifacts/${appId}/users/${currentUserId}/subscribedArtists`;

        let allContentData = [];
        let userPlaylists = [];
        let userLikedItemIds = new Set();
        let userSubscribedArtists = new Set();

        let unsubscribeContentItems = null;
        let unsubscribePlaylists = null;
        let unsubscribeLikedItems = null;
        let unsubscribeSubscribedArtists = null;

        onAuthStateChanged(auth, async (currentUser) => {
            console.log("onAuthStateChanged (User). User:", currentUser ? currentUser.uid : 'null', "App Initialized:", appInitialized);
            const previousUserId = userId;

            if (currentUser) {
                userId = currentUser.uid;
            } else {
                userId = null;
            }
            isAdminMode = (userId === ADMIN_UID && userId !== null);

            document.getElementById('profileUserName').textContent = userId ? `사용자 (${userId.substring(0, 6)}...)` : '로그인 필요';
            document.getElementById('profileUserId').textContent = `User ID: ${userId || 'N/A'}`;
            setupAdminUI();

            if (!appInitialized) {
                appInitialized = true;
                if (!currentUser) {
                    await attemptSignIn();
                } else {
                    await initializeAppLogic();
                }
            } else {
                if (userId !== previousUserId) {
                    await initializeAppLogic();
                } else {
                    // User is the same, but maybe content updated, re-render relevant parts if needed
                    // This is mostly handled by individual onSnapshot listeners
                }
            }
        });

        async function attemptSignIn() {
            console.log("Attempting sign-in (User)...");
            let signedInViaToken = false;
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token.trim() !== "") {
                try {
                    console.log("Attempting sign in with custom token (User)...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                    signedInViaToken = true;
                } catch (customTokenError) {
                    console.error("Error during custom token sign-in (User):", customTokenError);
                    showToast("커스텀 토큰 로그인 실패: " + customTokenError.message, true);
                }
            }
            if (!signedInViaToken && !auth.currentUser) {
                try {
                    console.log("Attempting anonymous sign-in (User)...");
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Error during anonymous sign-in (User):", anonError);
                    showToast("익명 로그인 실패: " + anonError.message, true);
                    if (!document.body.dataset.listenersAttached) {
                        setupEventListeners();
                        document.body.dataset.listenersAttached = "true";
                    }
                    renderPageContent(); renderMyPlaylists(); renderLikedSongs(); renderSubscribedArtists();
                }
            }
        }

        async function initializeAppLogic() {
            console.log("Initializing app logic (User). User ID:", userId);
            if (unsubscribePlaylists) { unsubscribePlaylists(); unsubscribePlaylists = null; }
            if (unsubscribeLikedItems) { unsubscribeLikedItems(); unsubscribeLikedItems = null; }
            if (unsubscribeSubscribedArtists) { unsubscribeSubscribedArtists(); unsubscribeSubscribedArtists = null; }
            userPlaylists = []; userLikedItemIds.clear(); userSubscribedArtists.clear();
            
            if (!document.body.dataset.listenersAttached) { // 이벤트 리스너 중복 방지
                 setupEventListeners();
                 document.body.dataset.listenersAttached = "true";
            }
            loadAllDataAndRender();
        }

        function setupAdminUI() {
            const adminElements = [
                document.querySelector('#desktopSidebar .nav-item[data-section="upload"]'),
                document.querySelector('#mobileSidebar .nav-item[data-section="upload"]'),
                document.getElementById('upload'),
                document.getElementById('adminUserIdDisplay')
            ];
            adminElements.forEach(el => { if (el) el.style.display = 'none'; if (el && el.id === 'upload') el.classList.remove('active');});
            const currentActiveSection = document.querySelector('.content-section.active');
            if (currentActiveSection && currentActiveSection.id === 'upload' && !isAdminMode) { switchSection('home'); }
        }

        function loadAllDataAndRender() {
            console.log("Loading all data and rendering (User). Current userId:", userId);
            console.log("Attempting to load content from:", getContentItemsCollectionPath());

            if (unsubscribeContentItems) { unsubscribeContentItems(); unsubscribeContentItems = null; }
            const contentItemsQuery = query(collection(db, getContentItemsCollectionPath()), orderBy('createdAt', 'desc'));
            unsubscribeContentItems = onSnapshot(contentItemsQuery, (qS) => {
                const previouslyDeletedItemIds = new Set(allContentData.filter(oldItem => !qS.docs.some(newDoc => newDoc.id === oldItem.itemId)).map(item => item.itemId));
                
                allContentData = qS.docs.map(d => ({ ...d.data(), itemId: d.id }));
                console.log("Content items loaded/updated (User):", allContentData.length);
                renderPageContent();

                // If items were deleted, check and update playlists
                if (previouslyDeletedItemIds.size > 0) {
                    console.log("Detected deleted items, checking playlists:", previouslyDeletedItemIds);
                    checkAndUpdatePlaylistsAfterContentDeletion(previouslyDeletedItemIds);
                }

                if (currentViewingPlaylistId && playlistDetailModal && !playlistDetailModal.classList.contains('hidden')) {
                    const p = userPlaylists.find(pl => pl.id === currentViewingPlaylistId);
                    if (p) openPlaylistDetailModal(currentViewingPlaylistId); else closePlaylistDetailModal(); // Playlist might have been deleted
                }
                renderLikedSongs(); // Liked songs might refer to items, re-render
            }, (err) => {
                console.error("Error fetching content items (User):", err);
                showToast('콘텐츠 로딩 실패: ' + err.message, true);
                allContentData = []; renderPageContent(); renderLikedSongs();
            });

            if (userId && !userId.startsWith('guest-')) {
                console.log("Loading user-specific data for (User):", userId);
                if (unsubscribePlaylists) { unsubscribePlaylists(); unsubscribePlaylists = null; }
                unsubscribePlaylists = onSnapshot(query(collection(db, getUserPlaylistsCollectionPath(userId)), orderBy('createdAt', 'desc')), (qS) => {
                    userPlaylists = qS.docs.map(d => ({ ...d.data(), id: d.id }));
                    renderMyPlaylists(); // This will now use the filtered items
                    if (currentViewingPlaylistId && playlistDetailModal && !playlistDetailModal.classList.contains('hidden')) {
                        const p = userPlaylists.find(pl => pl.id === currentViewingPlaylistId);
                        if (p) openPlaylistDetailModal(currentViewingPlaylistId); else closePlaylistDetailModal();
                    }
                }, (err) => { console.error("Error fetching playlists (User):", err); showToast("플레이리스트 로딩 실패", true); userPlaylists = []; renderMyPlaylists(); });

                if (unsubscribeLikedItems) { unsubscribeLikedItems(); unsubscribeLikedItems = null; }
                unsubscribeLikedItems = onSnapshot(collection(db, getUserLikedItemsCollectionPath(userId)), (qS) => {
                    userLikedItemIds.clear(); qS.forEach(d => userLikedItemIds.add(d.id));
                    renderLikedSongs(); renderPageContent();
                }, (err) => { console.error("Error fetching liked items (User):", err); showToast("좋아요 목록 로딩 실패", true); userLikedItemIds.clear(); renderLikedSongs(); });

                if (unsubscribeSubscribedArtists) { unsubscribeSubscribedArtists(); unsubscribeSubscribedArtists = null; }
                unsubscribeSubscribedArtists = onSnapshot(collection(db, getUserSubscribedArtistsCollectionPath(userId)), (qS) => {
                    userSubscribedArtists.clear(); qS.forEach(d => userSubscribedArtists.add(d.id));
                    renderSubscribedArtists(); renderPageContent();
                }, (err) => { console.error("Error fetching subscribed artists (User):", err); showToast("구독 아티스트 로딩 실패", true); userSubscribedArtists.clear(); renderSubscribedArtists(); });
            } else {
                userPlaylists = []; userLikedItemIds.clear(); userSubscribedArtists.clear();
                renderMyPlaylists(); renderLikedSongs(); renderSubscribedArtists();
                if (unsubscribePlaylists) { unsubscribePlaylists(); unsubscribePlaylists = null; }
                if (unsubscribeLikedItems) { unsubscribeLikedItems(); unsubscribeLikedItems = null; }
                if (unsubscribeSubscribedArtists) { unsubscribeSubscribedArtists(); unsubscribeSubscribedArtists = null; }
                renderPageContent();
            }
        }
        
        // Function to check and potentially update client-side playlist data if items were deleted
        // This does NOT write to Firestore, only updates local state for rendering
        function checkAndUpdatePlaylistsAfterContentDeletion(deletedItemIds) {
            if (!userId || userId.startsWith('guest-') || deletedItemIds.size === 0) return;

            let playlistsChanged = false;
            userPlaylists.forEach(playlist => {
                const originalItemCount = playlist.items.length;
                playlist.items = playlist.items.filter(itemId => !deletedItemIds.has(itemId));
                if (playlist.items.length !== originalItemCount) {
                    playlistsChanged = true;
                    // Note: This client-side filtering is for immediate UI consistency.
                    // The actual removal from Firestore playlist.items array should be done by admin/backend.
                    // If admin/backend handles it, onSnapshot for playlists will eventually update this too.
                    // This function provides a quicker UI update if global content is removed.
                    console.log(`Client-side filter: Playlist '${playlist.name}' items updated due to content deletion.`);
                }
            });

            if (playlistsChanged) {
                renderMyPlaylists(); // Re-render playlist section
                // If the currently open playlist detail modal was affected, refresh it
                if (currentViewingPlaylistId && playlistDetailModal && !playlistDetailModal.classList.contains('hidden')) {
                    const currentPlaylist = userPlaylists.find(p => p.id === currentViewingPlaylistId);
                    if (currentPlaylist) {
                        openPlaylistDetailModal(currentViewingPlaylistId); // Re-open to reflect changes
                    } else {
                        closePlaylistDetailModal(); // Playlist itself might have become empty or problematic
                    }
                }
            }
        }


        const activeNavClass = 'neon-accent-bg';
        const inactiveNavClass = 'hover:bg-purple-700/30';
        let desktopSidebar, mobileSidebar, mobileSidebarOverlay, mobileMenuButton, closeMobileSidebarButton;
        let aionLogoDesktop, aionLogoMobile;

        function initializeMenuElements() {
            desktopSidebar = document.getElementById('desktopSidebar'); mobileSidebar = document.getElementById('mobileSidebar');
            mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay'); mobileMenuButton = document.getElementById('mobileMenuButton');
            closeMobileSidebarButton = document.getElementById('closeMobileSidebarButton');
            aionLogoDesktop = document.getElementById('aionLogoDesktop'); aionLogoMobile = document.getElementById('aionLogoMobile');
        }

        function setInitialActiveSection() {
            if (!desktopSidebar || !mobileSidebar) { initializeMenuElements(); if (!desktopSidebar || !mobileSidebar) return; }
            document.querySelectorAll('.content-section').forEach(section => { section.style.display = 'none'; section.classList.remove('active'); });
            const homeSection = document.getElementById('home');
            if (homeSection) { homeSection.classList.add('active'); homeSection.style.display = 'block'; }
            document.querySelectorAll('#desktopSidebar .nav-item, #mobileSidebar .nav-item').forEach(nav => {
                nav.classList.remove(activeNavClass); nav.classList.add(inactiveNavClass);
                if (nav.dataset.section === 'upload' && nav.style.display !== 'none') { nav.style.display = 'none'; }
            });
            const homeNavItemDesktop = desktopSidebar.querySelector('.nav-item[data-section="home"]');
            const homeNavItemMobile = mobileSidebar.querySelector('.nav-item[data-section="home"]');
            if (homeNavItemDesktop) { homeNavItemDesktop.classList.add(activeNavClass); homeNavItemDesktop.classList.remove(inactiveNavClass); }
            if (homeNavItemMobile) { homeNavItemMobile.classList.add(activeNavClass); homeNavItemMobile.classList.remove(inactiveNavClass); }
        }

        function switchSection(sectionId) {
            if (sectionId === 'upload' && !isAdminMode) { switchSection('home'); return; }
            document.querySelectorAll('.content-section').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) { targetSection.style.display = 'block'; targetSection.classList.add('active'); }
            updateNavActiveState(sectionId);
        }

        function updateNavActiveState(activeSectionId) {
            if (!desktopSidebar || !mobileSidebar) return;
            document.querySelectorAll('#desktopSidebar .nav-item, #mobileSidebar .nav-item').forEach(nav => {
                if (nav.dataset.section === 'upload' && nav.style.display !== 'none' && !isAdminMode) { nav.style.display = 'none'; }
                nav.classList.remove(activeNavClass); nav.classList.add(inactiveNavClass);
                if (nav.dataset.section === activeSectionId) { nav.classList.add(activeNavClass); nav.classList.remove(inactiveNavClass); }
            });
        }
        
        function reattachEventListener(element, eventType, handler) {
            if (!element) return null; // Return null if element doesn't exist
            const newElement = element.cloneNode(true);
            element.parentNode.replaceChild(newElement, element);
            newElement.addEventListener(eventType, handler);
            return newElement;
        }

        function setupEventListeners() {
            initializeMenuElements();
            setInitialActiveSection();
        
            document.querySelectorAll('#desktopSidebar .nav-item, #mobileSidebar .nav-item').forEach(item => {
                const sectionId = item.dataset.section;
                if (sectionId === 'upload' && !isAdminMode) {
                    item.style.display = 'none';
                    return; // Skip adding listener to hidden admin items
                }
                // Clone and replace to remove old listeners, then add new one
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
                newItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchSection(sectionId);
                    if (mobileSidebar && !mobileSidebar.classList.contains('-translate-x-full')) closeMobileSidebar();
                });
            });
        
            mobileMenuButton = reattachEventListener(mobileMenuButton, 'click', openMobileSidebar);
            closeMobileSidebarButton = reattachEventListener(closeMobileSidebarButton, 'click', closeMobileSidebar);
            mobileSidebarOverlay = reattachEventListener(mobileSidebarOverlay, 'click', closeMobileSidebar);
            aionLogoDesktop = reattachEventListener(aionLogoDesktop, 'click', (e) => { e.preventDefault(); switchSection('home'); });
            aionLogoMobile = reattachEventListener(aionLogoMobile, 'click', (e) => { e.preventDefault(); switchSection('home'); closeMobileSidebar(); });
        
            let tempCloseYoutubeModalButton = document.getElementById('closeYoutubeModalButton');
            tempCloseYoutubeModalButton = reattachEventListener(tempCloseYoutubeModalButton, 'click', closeYoutubeModal);
            
            let tempYoutubeModalElement = document.getElementById('youtubeModal');
            if (tempYoutubeModalElement) {
                const newModal = tempYoutubeModalElement.cloneNode(true);
                tempYoutubeModalElement.parentNode.replaceChild(newModal, tempYoutubeModalElement);
                youtubeModal = newModal; // Update global reference for the modal itself
                youtubePlayer = youtubeModal.querySelector('#youtubePlayer'); // Re-assign player from the new modal
                youtubeModal.addEventListener('click', (event) => { if (event.target === youtubeModal) closeYoutubeModal(); });
            }
        
            let tempCreatePlaylistButton = document.getElementById('createPlaylistButton');
            tempCreatePlaylistButton = reattachEventListener(tempCreatePlaylistButton, 'click', () => openCreatePlaylistModal());
            let tempCancelCreatePlaylist = document.getElementById('cancelCreatePlaylist');
            tempCancelCreatePlaylist = reattachEventListener(tempCancelCreatePlaylist, 'click', () => closeCreatePlaylistModal());
            let tempConfirmCreatePlaylist = document.getElementById('confirmCreatePlaylist');
            tempConfirmCreatePlaylist = reattachEventListener(tempConfirmCreatePlaylist, 'click', handleConfirmCreatePlaylist);
        
            let tempCancelAddToPlaylist = document.getElementById('cancelAddToPlaylist');
            tempCancelAddToPlaylist = reattachEventListener(tempCancelAddToPlaylist, 'click', () => closeAddToPlaylistModal());
            let tempConfirmAddToPlaylist = document.getElementById('confirmAddToPlaylist');
            tempConfirmAddToPlaylist = reattachEventListener(tempConfirmAddToPlaylist, 'click', handleConfirmAddToPlaylist);
        
            let tempClosePlaylistDetailModalButton = document.getElementById('closePlaylistDetailModal');
            tempClosePlaylistDetailModalButton = reattachEventListener(tempClosePlaylistDetailModalButton, 'click', () => closePlaylistDetailModal());
            let tempDeletePlaylistButton = document.getElementById('deletePlaylistButton');
            tempDeletePlaylistButton = reattachEventListener(tempDeletePlaylistButton, 'click', handleDeletePlaylist);
        
            document.body.removeEventListener('click', handleContentInteraction); // Remove if exists
            document.body.addEventListener('click', handleContentInteraction);
        }

        function openMobileSidebar() { if (mobileSidebar && mobileSidebarOverlay) { mobileSidebar.classList.remove('-translate-x-full'); mobileSidebarOverlay.classList.remove('hidden'); } }
        function closeMobileSidebar() { if (mobileSidebar && mobileSidebarOverlay) { mobileSidebar.classList.add('-translate-x-full'); mobileSidebarOverlay.classList.add('hidden'); } }

        const defaultThumbnail = 'https://placehold.co/320x180/1A0933/4A2270?text=썸네일+미리보기';
        const thumbnailErrorPlaceholder = 'https://placehold.co/300x180/330033/FFFFFF?text=썸네일+오류';
        function getYouTubeId(url) { if (!url) return ''; let videoId = ''; const patterns = [ /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^& \n<]{11})/, /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^? \n<]{11})/, /(?:https?:\/\/)?youtu\.be\/([^? \n<]{11})/, ]; for (const pattern of patterns) { const match = url.match(pattern); if (match && match[1]) { videoId = match[1]; break; } } if (!videoId) console.warn("Could not extract YouTube ID from URL:", url); return videoId; }
        function getYouTubeThumbnailUrl(videoId) { return videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : defaultThumbnail; }
        const toastMessageElement = document.getElementById('toastMessage');
        function showToast(message, isError = false) { if (!toastMessageElement) return; toastMessageElement.textContent = message; toastMessageElement.className = `toast-message show ${isError ? 'bg-red-600' : 'neon-accent-bg'}`; setTimeout(() => { toastMessageElement.classList.remove('show'); }, 3000); }

        const newUploadsContainer = document.getElementById('newUploadsContainer');
        const newUploadsPlaceholder = document.getElementById('newUploadsPlaceholder');
        const aionChartContainer = document.getElementById('aionChartContainer');
        const aionChartPlaceholder = document.getElementById('aionChartPlaceholder');
        const recommendedMusicContainer = document.getElementById('recommendedMusicContainer');
        const recommendedMusicPlaceholder = document.getElementById('recommendedMusicPlaceholder');

        function createContentItemHTML(itemData) {
            let tagsHTML = '';
            const allDisplayTags = [];

            if (itemData.themes && Array.isArray(itemData.themes) && itemData.themes.length > 0) {
                allDisplayTags.push(...itemData.themes.map(tag => `#${tag.trim()}`));
            }
            if (itemData.genres && Array.isArray(itemData.genres) && itemData.genres.length > 0) {
                allDisplayTags.push(...itemData.genres.map(tag => `<span class="text-purple-400">#${tag.trim()}</span>`));
            }
            if (itemData.moods && Array.isArray(itemData.moods) && itemData.moods.length > 0) {
                allDisplayTags.push(...itemData.moods.map(tag => `<span class="text-green-300">#${tag.trim()}</span>`));
            }
            if (itemData.tags) { // Manually entered tags from admin upload
                const manualTags = itemData.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                if (manualTags.length > 0) {
                    allDisplayTags.push(...manualTags.map(tag => `#${tag}`));
                }
            }
            
            tagsHTML = [...new Set(allDisplayTags)].join(' ');

            if (itemData.isInstrumental) {
                 tagsHTML += ` <span class="text-cyan-400">#Instrumental</span>`;
            }
            if (typeof itemData.views === 'number') {
                tagsHTML += ` <span class="text-yellow-300 ml-2"><i class="fas fa-eye text-xs"></i> ${itemData.views}</span>`;
            }

            let actionButtonsHTML = `<div class="item-action-icon-wrapper">`;
            if (userId && !userId.startsWith('guest-')) {
                actionButtonsHTML += `<i class="fas fa-list-ul item-action-icon add-to-playlist-icon" title="플레이리스트에 추가"></i>`;
                const isLiked = userLikedItemIds.has(itemData.itemId);
                actionButtonsHTML +=`<i class="${isLiked ? 'fas fa-heart text-red-500' : 'far fa-heart'} item-action-icon like-item-button" title="${isLiked ? '좋아요 취소' : '좋아요'}"></i>`;
            }
            actionButtonsHTML += `</div>`;

            const imageClass = "h-full";
            const artistDisplay = itemData.aiMusicArtist || itemData.aiTool || 'N/A';
            let subscribeIconHTML = '';
            if (userId && !userId.startsWith('guest-') && artistDisplay !== 'N/A') {
                const isSubscribed = userSubscribedArtists.has(artistDisplay);
                subscribeIconHTML = `<i class="${isSubscribed ? 'fas fa-heart text-red-500' : 'far fa-heart'} subscribe-artist-icon" data-artist-name="${artistDisplay}" title="${isSubscribed ? artistDisplay + ' 구독 취소' : artistDisplay + ' 구독'}"></i>`;
            }
            return `
                ${actionButtonsHTML}
                <div class="thumbnail-image-container mb-1">
                    <img src="${getYouTubeThumbnailUrl(itemData.youtubeId)}" alt="${itemData.title}" class="thumbnail-image ${imageClass}" onerror="this.onerror=null;this.src='${thumbnailErrorPlaceholder}';">
                </div>
                <h4 class="item-title truncate">${itemData.title}</h4>
                <div class="item-artist-wrapper">
                    <p class="item-artist text-gray-400 truncate">${artistDisplay}</p>
                    ${subscribeIconHTML}
                </div>
                <span class="item-tags neon-accent">${tagsHTML}</span>`;
        }

        function renderContentItem(itemData, container) {
            if (!container) return;
            const newItemDiv = document.createElement('div');
            newItemDiv.className = 'youtube-playable glassmorphism p-2 sm:p-3 rounded-lg hover:shadow-lg hover:shadow-purple-500/30 transition-shadow cursor-pointer flex flex-col';
            newItemDiv.dataset.youtubeId = itemData.youtubeId;
            newItemDiv.dataset.itemId = itemData.itemId;
            newItemDiv.innerHTML = createContentItemHTML(itemData);
            if (container === newUploadsContainer) {
                container.insertBefore(newItemDiv, container.firstChild);
            } else {
                container.appendChild(newItemDiv);
            }
        }
        function clearContainer(container, placeholder) { if (!container) return; Array.from(container.children).filter(c => c !== placeholder).forEach(c => container.removeChild(c)); }

        function renderPageContent() {
            renderNewUploadsSection(); renderAionChart(); renderRecommendedMusicSection();
        }
        function renderNewUploadsSection() {
            if (!newUploadsContainer) return; clearContainer(newUploadsContainer, newUploadsPlaceholder);
            if (allContentData.length > 0) { if(newUploadsPlaceholder) newUploadsPlaceholder.classList.add('hidden'); allContentData.forEach(item => renderContentItem(item, newUploadsContainer)); }
            else { if(newUploadsPlaceholder) { newUploadsPlaceholder.classList.remove('hidden'); newUploadsPlaceholder.textContent = "업로드된 콘텐츠가 없습니다."; } }
        }
        function renderRecommendedMusicSection() {
            if (!recommendedMusicContainer) return; clearContainer(recommendedMusicContainer, recommendedMusicPlaceholder);
            const items = allContentData.filter(item => item.isRecommended === true);
            if (items.length > 0) { if(recommendedMusicPlaceholder) recommendedMusicPlaceholder.classList.add('hidden'); items.forEach(item => renderContentItem(item, recommendedMusicContainer)); }
            else { if(recommendedMusicPlaceholder) { recommendedMusicPlaceholder.classList.remove('hidden'); recommendedMusicPlaceholder.textContent = "추천 음악이 없습니다."; } }
        }
        function renderAionChart() {
            if (!aionChartContainer) return; clearContainer(aionChartContainer, aionChartPlaceholder);
            const items = [...allContentData].filter(i => (i.views || 0) > 0).sort((a,b) => (b.views||0) - (a.views||0)).slice(0,10);
            if (items.length > 0) { if(aionChartPlaceholder) aionChartPlaceholder.classList.add('hidden'); items.forEach(item => renderContentItem(item, aionChartContainer)); }
            else { if(aionChartPlaceholder) { aionChartPlaceholder.classList.remove('hidden'); aionChartPlaceholder.textContent = "차트 데이터가 없습니다."; } }
        }

        let youtubeModal = document.getElementById('youtubeModal');
        let youtubePlayer = document.getElementById('youtubePlayer');
        let currentItemToAddToPlaylist = null;

        async function handleContentInteraction(event) {
            if (!appInitialized) return;
            const targetPlayableItem = event.target.closest('.youtube-playable');
            const targetAddToPlaylistButton = event.target.closest('.add-to-playlist-icon');
            const targetSubscribeButton = event.target.closest('.subscribe-artist-icon');
            const targetLikeButton = event.target.closest('.like-item-button');

            if (targetPlayableItem && !targetAddToPlaylistButton && !targetSubscribeButton && !targetLikeButton) {
                const youtubeId = targetPlayableItem.dataset.youtubeId; const itemId = targetPlayableItem.dataset.itemId;
                if (youtubeId && itemId) openYoutubeModal(youtubeId, itemId);
            }
            if (targetAddToPlaylistButton) {
                event.stopPropagation(); if (!userId || userId.startsWith('guest-')) { showToast("로그인이 필요한 기능입니다.", true); return; }
                currentItemToAddToPlaylist = targetAddToPlaylistButton.closest('.youtube-playable')?.dataset.itemId;
                if (currentItemToAddToPlaylist) openAddToPlaylistModal();
            }
            if (targetSubscribeButton) {
                event.stopPropagation(); if (!userId || userId.startsWith('guest-')) { showToast("로그인이 필요한 기능입니다.", true); return; }
                const artistName = targetSubscribeButton.dataset.artistName;
                if (artistName && artistName !== 'N/A') await toggleArtistSubscription(artistName);
            }
            if (targetLikeButton) {
                event.stopPropagation(); if (!userId || userId.startsWith('guest-')) { showToast("로그인이 필요한 기능입니다.", true); return; }
                const itemIdToLike = targetLikeButton.closest('.youtube-playable')?.dataset.itemId;
                if(itemIdToLike) await toggleLikeItem(itemIdToLike);
            }
        }

        function openYoutubeModal(youtubeId, itemId) {
            youtubeModal = document.getElementById('youtubeModal'); youtubePlayer = document.getElementById('youtubePlayer');
            if (youtubePlayer && youtubeModal) {
                youtubePlayer.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1&rel=0`;
                youtubeModal.classList.remove('hidden'); youtubeModal.classList.add('flex');
                incrementViewCount(itemId);
            }
        }
        function closeYoutubeModal() {
            youtubeModal = document.getElementById('youtubeModal'); youtubePlayer = document.getElementById('youtubePlayer');
            if (youtubePlayer && youtubeModal) { youtubePlayer.src = ''; youtubeModal.classList.add('hidden'); youtubeModal.classList.remove('flex'); }
        }
        async function incrementViewCount(itemId) { if (!itemId) return; try { const itemRef = doc(db, getContentItemsCollectionPath(), itemId); await updateDoc(itemRef, { views: increment(1) }); console.log(`View count for ${itemId}`); } catch (error) { console.error('Error incrementing view count:', error); } }

        const myPlaylistsContainer = document.getElementById('myPlaylistsContainer');
        const myPlaylistsPlaceholder = document.getElementById('myPlaylistsPlaceholder');
        const createPlaylistModal = document.getElementById('createPlaylistModal');
        const newPlaylistNameInput = document.getElementById('newPlaylistName');
        const addToPlaylistModal = document.getElementById('addToPlaylistModal');
        const playlistSelectionContainer = document.getElementById('playlistSelectionContainer');
        const playlistSelectionPlaceholder = document.getElementById('playlistSelectionPlaceholder');
        const newPlaylistNameInAddModalInput = document.getElementById('newPlaylistNameInAddModal');
        let playlistDetailModal = document.getElementById('playlistDetailModal');
        const playlistDetailNameElement = document.getElementById('playlistDetailName');
        const playlistDetailItemsContainer = document.getElementById('playlistDetailItemsContainer');
        const playlistDetailPlaceholder = document.getElementById('playlistDetailPlaceholder');
        let currentViewingPlaylistId = null;

        function openCreatePlaylistModal() { if (!userId || userId.startsWith('guest-')) { showToast("로그인이 필요합니다.", true); return; } if (createPlaylistModal) createPlaylistModal.classList.remove('hidden'); if (newPlaylistNameInput) newPlaylistNameInput.value = ''; }
        function closeCreatePlaylistModal() { if (createPlaylistModal) createPlaylistModal.classList.add('hidden'); }
        async function handleConfirmCreatePlaylist() { if (!userId || userId.startsWith('guest-')) { showToast("로그인이 필요합니다.", true); return; } const playlistName = newPlaylistNameInput.value.trim(); if (playlistName) { try { await addDoc(collection(db, getUserPlaylistsCollectionPath(userId)), { name: playlistName, items: [], ownerId: userId, createdAt: serverTimestamp() }); closeCreatePlaylistModal(); showToast(`플레이리스트 '${playlistName}' 생성됨.`); } catch (error) { console.error("Error creating playlist:", error); showToast("플레이리스트 생성 오류.", true); } } else { showToast('플레이리스트 이름을 입력해주세요.', true); } }

        function openAddToPlaylistModal() {
            if (!userId || userId.startsWith('guest-')) { showToast("로그인이 필요합니다.", true); return; }
            if (!addToPlaylistModal || !playlistSelectionContainer || !playlistSelectionPlaceholder) return;
            playlistSelectionContainer.innerHTML = '';
            if (userPlaylists.length > 0) {
                if (playlistSelectionPlaceholder) playlistSelectionPlaceholder.classList.add('hidden');
                userPlaylists.forEach(pl => {
                    const div = document.createElement('div'); div.className = 'flex items-center space-x-2 p-2 hover:bg-purple-700/30 rounded-md cursor-pointer'; div.dataset.playlistId = pl.id;
                    const input = document.createElement('input'); input.type = 'radio'; input.name = 'playlistSelection'; input.value = pl.id; input.className = 'form-radio h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 focus:ring-purple-500'; input.id = `pl-select-${pl.id}`;
                    const label = document.createElement('label'); label.htmlFor = `pl-select-${pl.id}`; label.textContent = pl.name; label.className = 'text-sm flex-grow cursor-pointer';
                    div.appendChild(input); div.appendChild(label); div.addEventListener('click', () => { input.checked = true; });
                    playlistSelectionContainer.appendChild(div);
                });
            } else { if (playlistSelectionPlaceholder) { playlistSelectionPlaceholder.classList.remove('hidden'); playlistSelectionPlaceholder.textContent = "플레이리스트 없음. 먼저 생성하세요."; } }
            if (newPlaylistNameInAddModalInput) newPlaylistNameInAddModalInput.value = '';
            addToPlaylistModal.classList.remove('hidden');
        }
        function closeAddToPlaylistModal() { if (addToPlaylistModal) addToPlaylistModal.classList.add('hidden'); currentItemToAddToPlaylist = null; }
        async function handleConfirmAddToPlaylist() {
            if (!userId || userId.startsWith('guest-') || !currentItemToAddToPlaylist) { return; }
            const selectedRadio = playlistSelectionContainer.querySelector('input[name="playlistSelection"]:checked');
            const newPlaylistName = newPlaylistNameInAddModalInput.value.trim();
            let playlistNameForToast = "";
            try {
                const itemToAddRef = doc(db, getContentItemsCollectionPath(), currentItemToAddToPlaylist);
                const itemSnap = await getDoc(itemToAddRef);
                if (!itemSnap.exists()) { showToast("추가하려는 곡 없음. 삭제되었을 수 있음.", true); closeAddToPlaylistModal(); return; }
                if (newPlaylistName) {
                    await addDoc(collection(db, getUserPlaylistsCollectionPath(userId)), { name: newPlaylistName, items: [currentItemToAddToPlaylist], ownerId: userId, createdAt: serverTimestamp() });
                    playlistNameForToast = newPlaylistName; showToast(`'${playlistNameForToast}'에 곡 추가됨.`);
                } else if (selectedRadio) {
                    const targetPlaylistId = selectedRadio.value; const playlist = userPlaylists.find(p => p.id === targetPlaylistId);
                    if (playlist) {
                        playlistNameForToast = playlist.name;
                        if (!playlist.items.includes(currentItemToAddToPlaylist)) {
                            const playlistRef = doc(db, getUserPlaylistsCollectionPath(userId), targetPlaylistId);
                            await updateDoc(playlistRef, { items: [...playlist.items, currentItemToAddToPlaylist] });
                            showToast(`'${playlistNameForToast}'에 곡 추가됨.`);
                        } else { showToast('이미 플레이리스트에 있는 곡입니다.'); }
                    } else { showToast('선택한 플레이리스트 없음.', true); return; }
                } else { showToast('플레이리스트 선택 또는 새 이름 입력.', true); return; }
                closeAddToPlaylistModal();
            } catch (error) { console.error("Error adding to playlist:", error); showToast("플레이리스트 추가 오류.", true); }
        }

        function renderMyPlaylists() {
            if (!myPlaylistsContainer || !myPlaylistsPlaceholder) return; clearContainer(myPlaylistsContainer, myPlaylistsPlaceholder);
            if (!userId || userId.startsWith('guest-')) { if(myPlaylistsPlaceholder) { myPlaylistsPlaceholder.classList.remove('hidden'); myPlaylistsPlaceholder.textContent = "플레이리스트 보려면 로그인하세요."; } return; }
            
            const validPlaylists = userPlaylists.map(pl => {
                const validItems = pl.items ? pl.items.filter(itemId => allContentData.some(content => content.itemId === itemId)) : [];
                // Firestore 업데이트는 관리자/백엔드에서 처리해야 함. 여기서는 UI 필터링만.
                // if (pl.items && validItems.length < pl.items.length) {
                //    console.log(`Playlist '${pl.name}' has item IDs for deleted content. UI will filter them out.`);
                // }
                return { ...pl, displayItems: validItems }; // Store filtered items for display count
            });

            if (validPlaylists.length > 0) {
                if(myPlaylistsPlaceholder) myPlaylistsPlaceholder.classList.add('hidden');
                validPlaylists.forEach(pl => {
                    const card = document.createElement('div'); card.className = 'playlist-card glassmorphism cursor-pointer'; card.dataset.playlistId = pl.id;
                    const cover = document.createElement('div'); cover.className = 'playlist-cover';
                    if (pl.displayItems.length > 0) { // Use displayItems for cover
                        const firstItemId = pl.displayItems[0]; // This is an actual item ID from filtered list
                        const firstItemData = allContentData.find(item => item.itemId === firstItemId); // Should always find
                        if (firstItemData && firstItemData.youtubeId) {
                            const img = document.createElement('img'); img.src = getYouTubeThumbnailUrl(firstItemData.youtubeId); img.alt = pl.name; img.className = 'w-full h-full object-cover rounded-md';
                            img.onerror = function() { this.parentElement.innerHTML = '<i class="fas fa-music text-3xl"></i>'; }; cover.appendChild(img);
                        } else { cover.innerHTML = '<i class="fas fa-music text-3xl"></i>'; }
                    } else { cover.innerHTML = '<i class="fas fa-music text-3xl"></i>'; }
                    const info = document.createElement('div'); info.className = 'flex-grow';
                    const name = document.createElement('h4'); name.className = 'font-semibold text-sm truncate'; name.textContent = pl.name;
                    const count = document.createElement('p'); count.className = 'text-xs text-gray-400'; count.textContent = `${pl.displayItems.length}곡`; // Count based on displayable items
                    info.appendChild(name); info.appendChild(count); card.appendChild(cover); card.appendChild(info);
                    card.addEventListener('click', () => openPlaylistDetailModal(pl.id)); myPlaylistsContainer.appendChild(card);
                });
            } else { if(myPlaylistsPlaceholder) { myPlaylistsPlaceholder.classList.remove('hidden'); myPlaylistsPlaceholder.textContent = "만든 플레이리스트가 없습니다."; } }
        }

        function openPlaylistDetailModal(playlistId) {
            playlistDetailModal = document.getElementById('playlistDetailModal'); currentViewingPlaylistId = playlistId;
            const playlist = userPlaylists.find(p => p.id === playlistId);
            if (!playlist || !playlistDetailModal || !playlistDetailNameElement || !playlistDetailItemsContainer || !playlistDetailPlaceholder) {
                console.warn("Cannot open playlist detail, playlist or elements not found for ID:", playlistId);
                closePlaylistDetailModal(); // Ensure modal is closed if something is wrong
                return;
            }
            playlistDetailNameElement.textContent = playlist.name; clearContainer(playlistDetailItemsContainer, playlistDetailPlaceholder);
            
            const itemsToDisplay = playlist.items ? playlist.items.map(itemId => {
                return allContentData.find(item => item.itemId === itemId);
            }).filter(itemData => itemData) : []; // Filter out items not found in allContentData

            if (itemsToDisplay.length > 0) {
                if(playlistDetailPlaceholder) playlistDetailPlaceholder.classList.add('hidden');
                itemsToDisplay.forEach(itemData => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'glassmorphism p-3 rounded-lg flex items-center justify-between hover:bg-purple-700/20';
                    const img = document.createElement('img'); img.src = getYouTubeThumbnailUrl(itemData.youtubeId); img.alt = itemData.title; img.className = 'w-12 h-12 object-cover rounded-md mr-3 cursor-pointer';
                    img.onerror = function() { this.src = thumbnailErrorPlaceholder; }; img.addEventListener('click', (e) => { e.stopPropagation(); openYoutubeModal(itemData.youtubeId, itemData.itemId); });
                    const textInfoDiv = document.createElement('div'); textInfoDiv.className = 'flex-grow cursor-pointer'; textInfoDiv.addEventListener('click', (e) => { e.stopPropagation(); openYoutubeModal(itemData.youtubeId, itemData.itemId); });
                    const titleH5 = document.createElement('h5'); titleH5.className = 'item-title truncate'; titleH5.textContent = itemData.title;
                    const artistP = document.createElement('p'); artistP.className = 'item-artist text-gray-400 truncate'; artistP.textContent = itemData.aiMusicArtist || itemData.aiTool || 'N/A';
                    textInfoDiv.appendChild(titleH5); textInfoDiv.appendChild(artistP);
                    const actionButtonsContainer = document.createElement('div'); actionButtonsContainer.className = 'flex items-center';
                    const removeButton = document.createElement('button'); removeButton.className = 'p-2 text-red-400 hover:text-red-600 ml-2'; removeButton.innerHTML = '<i class="fas fa-times"></i>'; removeButton.title = "플레이리스트에서 삭제";
                    removeButton.addEventListener('click', async (e) => { e.stopPropagation(); await removeSongFromPlaylist(playlistId, itemData.itemId); });
                    actionButtonsContainer.appendChild(removeButton); itemDiv.appendChild(img); itemDiv.appendChild(textInfoDiv); itemDiv.appendChild(actionButtonsContainer);
                    playlistDetailItemsContainer.appendChild(itemDiv);
                });
            } else { if(playlistDetailPlaceholder) { playlistDetailPlaceholder.classList.remove('hidden'); playlistDetailPlaceholder.textContent = "이 플레이리스트에 곡이 없습니다."; } }
            playlistDetailModal.classList.remove('hidden');
        }
        function closePlaylistDetailModal() { playlistDetailModal = document.getElementById('playlistDetailModal'); if(playlistDetailModal) playlistDetailModal.classList.add('hidden'); currentViewingPlaylistId = null; }
        async function handleDeletePlaylist() {
            if (!userId || userId.startsWith('guest-') || !currentViewingPlaylistId) return;
            const playlist = userPlaylists.find(p => p.id === currentViewingPlaylistId);
            if (playlist) {
                const confirmDelete = await showConfirmationModal(`'${playlist.name}' 플레이리스트 삭제?`);
                if (confirmDelete) {
                    try {
                        const playlistRef = doc(db, getUserPlaylistsCollectionPath(userId), currentViewingPlaylistId);
                        await deleteDoc(playlistRef); closePlaylistDetailModal(); showToast('플레이리스트 삭제됨.');
                    } catch (error) { console.error("Error deleting playlist:", error); showToast("플레이리스트 삭제 오류.", true); }
                }
            } else { showToast("삭제할 플레이리스트 없음.", true); }
        }
        function showConfirmationModal(message) {
            return new Promise((resolve) => {
                const existingModal = document.getElementById('customConfirmModal'); if (existingModal) existingModal.remove();
                const modalHtml = ` <div id="customConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100]"> <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-sm mx-4"> <p class="text-white mb-4 text-sm">${message}</p> <div class="flex justify-end space-x-3"> <button id="customConfirmCancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium text-white">취소</button> <button id="customConfirmOk" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium text-white">삭제</button> </div> </div> </div> `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const confirmModal = document.getElementById('customConfirmModal'); const okButton = document.getElementById('customConfirmOk'); const cancelButton = document.getElementById('customConfirmCancel');
                const removeModal = () => { if (confirmModal) confirmModal.remove(); };
                okButton.onclick = () => { removeModal(); resolve(true); }; cancelButton.onclick = () => { removeModal(); resolve(false); };
            });
        }
        async function removeSongFromPlaylist(playlistId, itemIdToRemove) {
            if (!userId || userId.startsWith('guest-')) return;
            const playlist = userPlaylists.find(pl => pl.id === playlistId);
            if (playlist) {
                const updatedItems = playlist.items.filter(id => id !== itemIdToRemove);
                try {
                    const playlistRef = doc(db, getUserPlaylistsCollectionPath(userId), playlistId);
                    await updateDoc(playlistRef, { items: updatedItems });
                    showToast('플레이리스트에서 곡 삭제됨.');
                    // UI will update via onSnapshot for playlists
                } catch (error) { console.error("Error removing song from playlist:", error); showToast("곡 삭제 오류.", true); }
            }
        }
        const likedSongsContainer = document.getElementById('likedSongsContainer');
        const likedSongsPlaceholder = document.getElementById('likedSongsPlaceholder');
        async function toggleLikeItem(itemId) {
            if (!userId || userId.startsWith('guest-') || !itemId) { if (!userId || userId.startsWith('guest-')) showToast("로그인이 필요한 기능입니다.", true); return; }
            const likeRef = doc(db, getUserLikedItemsCollectionPath(userId), itemId);
            try {
                const itemSnap = await getDoc(doc(db, getContentItemsCollectionPath(), itemId));
                if (!itemSnap.exists()) {
                    showToast("존재하지 않는 콘텐츠입니다.", true);
                    if (userLikedItemIds.has(itemId)) { userLikedItemIds.delete(itemId); renderLikedSongs(); renderPageContent(); }
                    return;
                }
                if (userLikedItemIds.has(itemId)) { await deleteDoc(likeRef); showToast('좋아요 취소됨.'); }
                else { await setDoc(likeRef, { likedAt: serverTimestamp(), itemId: itemId }); showToast('좋아요 곡에 추가됨.'); }
            } catch (error) { console.error("Error toggling like:", error); showToast("좋아요 처리 오류.", true); }
        }
        function renderLikedSongs() {
            if (!likedSongsContainer || !likedSongsPlaceholder) return; clearContainer(likedSongsContainer, likedSongsPlaceholder);
            if (!userId || userId.startsWith('guest-')) { if(likedSongsPlaceholder) { likedSongsPlaceholder.classList.remove('hidden'); likedSongsPlaceholder.textContent = "좋아요 곡 보려면 로그인하세요."; } return; }
            
            const likedItemsDetails = Array.from(userLikedItemIds)
                                      .map(likedId => allContentData.find(item => item.itemId === likedId))
                                      .filter(itemData => itemData); // Filter out items not found (deleted)
            
            if (likedItemsDetails.length > 0) {
                if(likedSongsPlaceholder) likedSongsPlaceholder.classList.add('hidden');
                likedItemsDetails.forEach(itemData => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'glassmorphism p-3 rounded-lg flex items-center justify-between hover:bg-purple-700/20';
                    const img = document.createElement('img'); img.src = getYouTubeThumbnailUrl(itemData.youtubeId); img.alt = itemData.title; img.className = 'w-12 h-12 object-cover rounded-md mr-3 cursor-pointer';
                    img.onerror = function() { this.src = thumbnailErrorPlaceholder; }; img.addEventListener('click', (e) => { e.stopPropagation(); openYoutubeModal(itemData.youtubeId, itemData.itemId); });
                    const textInfoDiv = document.createElement('div'); textInfoDiv.className = 'flex-grow cursor-pointer'; textInfoDiv.addEventListener('click', (e) => { e.stopPropagation(); openYoutubeModal(itemData.youtubeId, itemData.itemId); });
                    const titleH5 = document.createElement('h5'); titleH5.className = 'item-title truncate'; titleH5.textContent = itemData.title;
                    const artistP = document.createElement('p'); artistP.className = 'item-artist text-gray-400 truncate'; artistP.textContent = itemData.aiMusicArtist || itemData.aiTool || 'N/A';
                    textInfoDiv.appendChild(titleH5); textInfoDiv.appendChild(artistP);
                    const actionWrapper = document.createElement('div'); actionWrapper.className = 'flex items-center';
                    const unlikeButton = document.createElement('button'); unlikeButton.className = 'p-2 text-red-400 hover:text-red-600 ml-2'; unlikeButton.innerHTML = '<i class="fas fa-heart-broken"></i>'; unlikeButton.title = "좋아요 취소";
                    unlikeButton.addEventListener('click', async (e) => { e.stopPropagation(); await toggleLikeItem(itemData.itemId); });
                    actionWrapper.appendChild(unlikeButton); itemDiv.appendChild(img); itemDiv.appendChild(textInfoDiv); itemDiv.appendChild(actionWrapper);
                    likedSongsContainer.appendChild(itemDiv);
                });
            } else { if(likedSongsPlaceholder) { likedSongsPlaceholder.classList.remove('hidden'); likedSongsPlaceholder.textContent = "아직 좋아요 표시한 곡이 없습니다."; } }
        }
        const subscribedArtistsContainer = document.getElementById('subscribedArtistsContainer');
        const subscribedArtistsPlaceholder = document.getElementById('subscribedArtistsPlaceholder');
        async function toggleArtistSubscription(artistName) {
            if (!userId || userId.startsWith('guest-') || !artistName || artistName === 'N/A') { if (!userId || userId.startsWith('guest-')) showToast("로그인이 필요한 기능입니다.", true); else showToast('유효한 아티스트 이름 아님.', true); return; }
            const subRef = doc(db, getUserSubscribedArtistsCollectionPath(userId), artistName);
            try {
                if (userSubscribedArtists.has(artistName)) { await deleteDoc(subRef); showToast(`${artistName} 구독 취소됨.`); }
                else { await setDoc(subRef, { subscribedAt: serverTimestamp(), artistName: artistName }); showToast(`${artistName} 구독함.`); }
            } catch (error) { console.error("Error toggling subscription:", error); showToast("구독 처리 오류.", true); }
        }
        function renderSubscribedArtists() {
            if (!subscribedArtistsContainer || !subscribedArtistsPlaceholder) return; clearContainer(subscribedArtistsContainer, subscribedArtistsPlaceholder);
            if (!userId || userId.startsWith('guest-')) { if(subscribedArtistsPlaceholder) { subscribedArtistsPlaceholder.classList.remove('hidden'); subscribedArtistsPlaceholder.textContent = "구독 아티스트 보려면 로그인."; } return; }
            if (userSubscribedArtists.size > 0) {
                if(subscribedArtistsPlaceholder) subscribedArtistsPlaceholder.classList.add('hidden');
                Array.from(userSubscribedArtists).sort().forEach(artistName => {
                    const div = document.createElement('div'); div.className = 'flex items-center justify-between p-2 glassmorphism rounded-md hover:bg-purple-700/20';
                    const nameSpan = document.createElement('span'); nameSpan.className = 'text-sm truncate'; nameSpan.textContent = artistName;
                    const unsubscribeButton = document.createElement('button'); unsubscribeButton.className = 'text-xs text-red-400 hover:text-red-600 px-2 py-1 rounded hover:bg-red-700/20 flex-shrink-0'; unsubscribeButton.textContent = '구독 취소';
                    unsubscribeButton.addEventListener('click', async (e) => { e.stopPropagation(); await toggleArtistSubscription(artistName); });
                    div.appendChild(nameSpan); div.appendChild(unsubscribeButton); subscribedArtistsContainer.appendChild(div);
                });
            } else { if(subscribedArtistsPlaceholder) { subscribedArtistsPlaceholder.classList.remove('hidden'); subscribedArtistsPlaceholder.textContent = "아직 구독한 아티스트가 없습니다."; } }
        }

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a031a; color: #e0e0e0; overscroll-behavior: none; }
        .neon-accent { color: #8A2BE2; }
        .neon-accent-bg { background-color: #8A2BE2; }
        .sidebar-icon { transition: all 0.3s ease; }
        .sidebar-icon:hover { color: #8A2BE2; transform: scale(1.1); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .glassmorphism { background: rgba(20, 10, 40, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(138, 43, 226, 0.3); }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #8A2BE2; border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #701ebd; }
        .horizontal-scroll::-webkit-scrollbar { height: 6px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background: #8A2BE2; border-radius: 3px;}
        .modal.hidden { display: none; }
        .modal-content { max-height: 80vh; }

        .item-action-icon-wrapper { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; z-index: 10; }
        .item-action-icon { background-color: rgba(0,0,0,0.7); color: white; border-radius: 50%; cursor: pointer; transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; opacity: 0; display: inline-flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; font-size: 0.875rem; padding: 0.4rem; }
        .item-action-icon:hover { opacity: 1; transform: scale(1.15); }

        .like-item-button.fas.fa-heart { color: #ef4444; }
        .subscribe-artist-icon.fas.fa-heart { color: #ef4444; }

        .youtube-playable:hover .item-action-icon { opacity: 0.8; }
        .youtube-playable { position: relative; padding-top: 0.5rem; }

        .toast-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; padding: 10px 20px; border-radius: 8px; z-index: 10000; opacity: 0; transition: opacity 0.5s ease-in-out; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4); }
        .toast-message.show { opacity: 1; }

        .item-title { font-size: 0.75rem; font-weight: 500; line-height: 1.2; margin-bottom: 0.125rem; }
        .item-artist, .item-tags { font-size: 0.65rem; line-height: 1.2; }
        .item-tags { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: calc(0.65rem * 1.2 * 2);  }


        @media (min-width: 640px) {
            .item-title { font-size: 0.875rem; }
            .item-artist, .item-tags { font-size: 0.75rem; }
            .item-tags { min-height: calc(0.75rem * 1.2 * 2); }
            .item-action-icon-wrapper { flex-direction: row; gap: 0.35rem; }
            .item-action-icon { width: 2.5rem; height: 2.5rem; font-size: 1.125rem; padding: 0.5rem; }

        }
        @media (min-width: 768px) {
            .youtube-playable { padding-top: 0; }
        }
        .item-artist-wrapper { display: flex; align-items: center; margin-bottom: 0.25rem;}
        .playlist-card { display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem; transition: background-color 0.2s; }
        .playlist-card:hover { background-color: rgba(138, 43, 226, 0.2); }
        .playlist-cover { width: 4rem; height: 4rem; border-radius: 0.375rem; object-fit: cover; margin-right: 0.75rem; background-color: rgba(138, 43, 226, 0.3); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .playlist-cover i { font-size: 1.5rem; color: rgba(224, 224, 224, 0.7); }

        #mobileSidebar.hidden { transform: translateX(-100%); }
        #mobileSidebarOverlay.hidden { display: none; }

        .thumbnail-image-container { width: 100%; overflow: hidden; border-radius: 0.375rem; aspect-ratio: 16 / 9; margin-bottom: 0.25rem;  }
        .thumbnail-image { width: 100%; height: 100%; object-fit: cover; }

    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="desktopSidebar" class="hidden md:flex w-64 glassmorphism p-4 space-y-8 flex-col items-start fixed inset-y-0 left-0 z-30">
        <div id="aionLogoDesktop" class="flex items-center justify-start space-x-3 mb-10 cursor-pointer">
            <svg class="h-14 w-14 neon-accent" viewBox="0 0 24 24" fill="currentColor"> <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            <h1 class="text-4xl font-bold">AION</h1>
        </div>
        <nav class="space-y-4 flex-grow w-full">
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="home"> <i class="fas fa-home fa-fw text-xl sidebar-icon"></i>
                <span class="text-sm">홈</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="library">
                <i class="fas fa-list-alt fa-fw text-xl sidebar-icon"></i>
                <span class="text-sm">플레이 리스트</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="upload" style="display: none;"> <i class="fas fa-upload fa-fw text-xl sidebar-icon"></i>
                <span class="text-sm">업로드</span>
            </a>
        </nav>
        <div class="mt-auto w-full">
             <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="profile">
                <i class="fas fa-user-circle fa-fw text-xl sidebar-icon"></i>
                <span class="text-sm">프로필</span>
            </a>
        </div>
    </aside>

    <div id="mobileSidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    <aside id="mobileSidebar" class="fixed inset-y-0 left-0 w-64 glassmorphism p-4 space-y-8 flex flex-col items-start z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden">
        <div class="flex items-center justify-between w-full mb-6">
            <div id="aionLogoMobile" class="flex items-center space-x-3 cursor-pointer">
                <svg class="h-10 w-10 neon-accent" viewBox="0 0 24 24" fill="currentColor"> <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/> </svg>
                <h1 class="text-2xl font-bold">AION</h1>
            </div>
            <button id="closeMobileSidebarButton" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <nav class="space-y-3 flex-grow w-full">
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="home"> <i class="fas fa-home fa-fw text-lg sidebar-icon"></i>
                <span class="text-sm">홈</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="library">
                <i class="fas fa-list-alt fa-fw text-lg sidebar-icon"></i>
                <span class="text-sm">플레이 리스트</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="upload" style="display: none;"> <i class="fas fa-upload fa-fw text-lg sidebar-icon"></i>
                <span class="text-sm">업로드</span>
            </a>
        </nav>
        <div class="mt-auto w-full">
             <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="profile">
                <i class="fas fa-user-circle fa-fw text-lg sidebar-icon"></i>
                <span class="text-sm">프로필</span>
            </a>
        </div>
    </aside>


    <main id="mainContentArea" class="flex-1 md:ml-64 h-screen flex flex-col">
        <header class="p-4 glassmorphism sticky top-0 z-20 flex-shrink-0">
            <div class="flex items-center justify-between">
                <button id="mobileMenuButton" class="text-gray-300 hover:text-white md:hidden mr-3 p-2"> <i class="fas fa-bars text-xl"></i>
                </button>
                <div class="flex-grow">
                     <span id="adminUserIdDisplay" class="text-xs text-red-400 hidden"></span> </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button class="p-2 rounded-full hover:bg-purple-700/30">
                        <i class="fas fa-bell text-lg sm:text-xl"></i>
                    </button>
                    <img src="https://placehold.co/40x40/7F00FF/FFFFFF?text=U" alt="User Avatar" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full cursor-pointer" onclick="document.querySelector('.nav-item[data-section=\'profile\']').click()">
                </div>
            </div>
        </header>

        <div class="flex-grow p-4 sm:p-6 overflow-y-auto scrollable-content pb-6">
            <section id="home" class="content-section"> <div class="mb-8 sm:mb-10">
                    <h3 class="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 flex items-center"><i class="fas fa-chart-line mr-2 neon-accent"></i>AION 차트 <span class="text-xs sm:text-sm text-gray-400 ml-2">(조회수 TOP 10)</span></h3>
                    <div id="aionChartContainer" class="grid grid-cols-2 gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 sm:gap-3">
                        <p id="aionChartPlaceholder" class="text-gray-400 col-span-full text-sm">아직 차트에 표시할 콘텐츠가 없습니다. 영상을 시청하여 조회수를 올려보세요!</p>
                    </div>
                </div>
                <div class="mb-8 sm:mb-10">
                    <h3 class="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 flex items-center"><i class="fas fa-star mr-2 neon-accent"></i>추천 음악</h3>
                    <div id="recommendedMusicContainer" class="grid grid-cols-2 gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 sm:gap-3">
                         <p id="recommendedMusicPlaceholder" class="text-gray-400 col-span-full text-sm">추천된 음악이 없습니다.</p>
                    </div>
                </div>
                <div class="mb-8 sm:mb-10">
                    <h3 class="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 flex items-center"><i class="fas fa-music mr-2 neon-accent"></i>새로운 AI 음악 & MV</h3>
                    <div id="newUploadsContainer" class="grid grid-cols-2 gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 sm:gap-3">
                        <p id="newUploadsPlaceholder" class="text-gray-400 col-span-full text-sm">음악이나 뮤직비디오가 여기에 표시됩니다.</p>
                    </div>
                </div>
            </section>

            <section id="library" class="content-section">
                <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6">플레이 리스트</h2>
                <div class="space-y-8">
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg sm:text-xl font-medium">내 플레이리스트</h3>
                            <button id="createPlaylistButton" class="neon-accent-bg text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg text-xs sm:text-sm font-semibold hover:bg-purple-700 transition-colors">
                                <i class="fas fa-plus mr-1"></i> 새 플레이리스트
                            </button>
                        </div>
                        <div id="myPlaylistsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p id="myPlaylistsPlaceholder" class="text-gray-400 col-span-full text-sm">만든 플레이리스트가 없습니다.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-medium mb-3">좋아요 표시한 곡</h3>
                        <div id="likedSongsContainer" class="space-y-2">
                            <p id="likedSongsPlaceholder" class="text-gray-400 text-sm">아직 좋아요 표시한 곡이 없습니다.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-medium mb-3">구독한 AI 아티스트</h3>
                        <div id="subscribedArtistsContainer" class="space-y-2">
                             <p id="subscribedArtistsPlaceholder" class="text-gray-400 text-sm">아직 구독한 아티스트가 없습니다.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="upload" class="content-section" style="display:none;">
            </section>

            <section id="profile" class="content-section">
                <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6">내 프로필</h2>
                 <div class="glassmorphism p-6 sm:p-8 rounded-lg max-w-2xl mx-auto">
                    <div class="flex flex-col items-center space-y-4">
                        <img src="https://placehold.co/120x120/7F00FF/FFFFFF?text=U" alt="User Avatar" class="w-24 h-24 sm:w-32 sm:h-32 rounded-full border-4 border-purple-500">
                        <h3 id="profileUserName" class="text-xl sm:text-2xl font-semibold">사용자 로딩중...</h3>
                        <p id="profileUserId" class="text-gray-400 text-xs">User ID: 로딩중...</p>
                        <p class="text-gray-400 text-sm">AION 뮤직 플랫폼 사용자입니다.</p>
                        <button class="px-4 py-2 sm:px-6 sm:py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-medium transition-colors text-sm" disabled title="프로필 수정 기능은 현재 지원되지 않습니다.">프로필 수정 (준비중)</button>
                    </div>
                    <div class="mt-8">
                        <h4 class="text-base sm:text-lg font-medium mb-2">계정 상태</h4>
                        <p class="text-gray-400 text-sm">구독 상태: <span class="neon-accent">무료 사용자</span></p>
                        <p class="text-gray-400 text-sm">참고: 이 페이지는 데모용이며 실제 사용자 데이터는 저장되지 않을 수 있습니다.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="youtubeModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="glassmorphism p-1 md:p-2 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 relative">
            <button id="closeYoutubeModalButton" class="absolute -top-3 -right-3 md:top-2 md:right-2 text-white bg-purple-600 hover:bg-purple-800 rounded-full w-8 h-8 flex items-center justify-center text-xl z-10"> × </button>
            <div class="aspect-video"> <iframe id="youtubePlayer" width="100%" height="100%" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <div id="createPlaylistModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h3 class="text-xl font-semibold mb-4">새 플레이리스트 만들기</h3>
            <input type="text" id="newPlaylistName" placeholder="플레이리스트 이름" class="w-full p-3 rounded-lg bg-black/30 border border-purple-700/50 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4 text-sm text-white">
            <div class="flex justify-end space-x-3">
                <button id="cancelCreatePlaylist" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium text-white">취소</button>
                <button id="confirmCreatePlaylist" class="px-4 py-2 neon-accent-bg hover:bg-purple-700 rounded-lg text-sm font-medium text-white">만들기</button>
            </div>
        </div>
    </div>

    <div id="addToPlaylistModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h3 class="text-xl font-semibold mb-4">플레이리스트에 추가</h3>
            <div id="playlistSelectionContainer" class="space-y-2 mb-4 max-h-60 overflow-y-auto scrollable-content pr-2">
                <p id="playlistSelectionPlaceholder" class="text-gray-400 text-sm">플레이리스트가 없습니다. 먼저 플레이리스트를 만들어주세요.</p>
            </div>
            <input type="text" id="newPlaylistNameInAddModal" placeholder="또는 새 플레이리스트 이름 입력" class="w-full p-3 rounded-lg bg-black/30 border border-purple-700/50 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4 text-sm text-white">
            <div class="flex justify-end space-x-3">
                <button id="cancelAddToPlaylist" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium text-white">취소</button>
                <button id="confirmAddToPlaylist" class="px-4 py-2 neon-accent-bg hover:bg-purple-700 rounded-lg text-sm font-medium text-white">추가</button>
            </div>
        </div>
    </div>

    <div id="playlistDetailModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden p-4">
        <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-2xl modal-content mx-auto overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="playlistDetailName" class="text-2xl font-semibold">플레이리스트 이름</h3>
                <button id="closePlaylistDetailModal" class="text-gray-400 hover:text-white text-2xl">×</button>
            </div>
            <div id="playlistDetailItemsContainer" class="space-y-3 max-h-[calc(80vh-150px)] overflow-y-auto scrollable-content pr-2">
                <p id="playlistDetailPlaceholder" class="text-gray-400 text-sm">이 플레이리스트에 곡이 없습니다.</p>
            </div>
             <div class="mt-4 flex justify-end space-x-2">
                <button id="deletePlaylistButton" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium text-white">플레이리스트 삭제</button>
            </div>
        </div>
    </div>

    <div id="toastMessage" class="toast-message"></div>

</body>
</html>
