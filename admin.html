<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AION - AI Music & Video (Admin)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://www.youtube.com/iframe_api"></script> {/* YouTube Iframe API 로드 */}

    <script type="module">
        // Firebase SDK v11.6.1 (Modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, increment, writeBatch, collectionGroup, getDocs, Timestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // --- Global Firebase & App Variables ---
        let db, auth, functions, storage; 
        let userId = null;
        let isAdminMode = false; 
        let appInitialized = false;
        let ytPlayerInstance = null; // YouTube 플레이어 인스턴스 저장 변수

        const ADMIN_UID = "682WUG1HLca4zsq5hmgFGcP4pAM2"; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aion-admin-app'; 

        let firebaseConfig = {
            apiKey: "AIzaSyCAfrCXrHfYWUrvZ-SKqocCXu5QNCbFRH8", 
            authDomain: "aion-18c27.firebaseapp.com",
            databaseURL: "https://aion-18c27-default-rtdb.firebaseio.com",
            projectId: "aion-18c27",
            storageBucket: "aion-18c27.appspot.com",
            messagingSenderId: "496946227122",
            appId: "1:496946227122:web:3c7efdd7d014743f3126ab",
            measurementId: "G-K2F99M91CM"
        };

        if (typeof __firebase_config !== 'undefined') {
            try {
                const parsedConfig = JSON.parse(__firebase_config);
                firebaseConfig = { ...firebaseConfig, ...parsedConfig };
                console.log("Using provided Firebase config (Admin):", firebaseConfig);
            } catch (e) {
                console.error("Error parsing __firebase_config (Admin):", e);
                showToast("Firebase 설정 오류가 발생했습니다.", true);
            }
        } else {
            console.warn("Global __firebase_config not found. Using hardcoded Firebase config. (Admin)");
        }

        const firebaseApp = initializeApp(firebaseConfig);
        db = getFirestore(firebaseApp);
        auth = getAuth(firebaseApp);
        functions = getFunctions(firebaseApp);

        setPersistence(auth, browserLocalPersistence);

        const getContentItemsCollectionPath = () => `/artifacts/${appId}/public/data/contentItems`;
        const getUserPlaylistsCollectionPath = (currentUserId) => `/artifacts/${appId}/users/${currentUserId}/playlists`; 
        const getUserLikedItemsCollectionPath = (currentUserId) => `/artifacts/${appId}/users/${currentUserId}/likedItems`;
        const getUserSubscribedArtistsCollectionPath = (currentUserId) => `/artifacts/${appId}/users/${currentUserId}/subscribedArtists`;

        let allContentData = [];
        let userPlaylists = []; 
        let userLikedItemIds = new Set();
        let userSubscribedArtists = new Set();

        let unsubscribeContentItems = null;
        let unsubscribePlaylists = null;
        let unsubscribeLikedItems = null;
        let unsubscribeSubscribedArtists = null;

        const predefinedThemes = ["사랑", "우정", "이별", "희망", "꿈", "여행", "청춘", "위로", "그리움", "자연", "일상", "파티"];
        const predefinedGenres = ["발라드", "댄스", "팝", "K-Pop", "힙합", "R&B/Soul", "록", "메탈", "일렉트로닉", "재즈", "클래식", "포크", "인디", "트로트", "OST", "뉴에이지", "CCM"];
        const predefinedMoods = ["신나는", "잔잔한", "몽환적인", "슬픈", "행복한", "로맨틱한", "긴장감있는", "평화로운", "활기찬", "감성적인", "웅장한", "경쾌한", "어두운"];

        onAuthStateChanged(auth, async (currentUser) => {
            const previousUserId = userId;
            if (currentUser) { userId = currentUser.uid; isAdminMode = (userId === ADMIN_UID); } 
            else { userId = null; isAdminMode = false; }
            
            document.getElementById('profileUserName').textContent = userId ? `${isAdminMode ? '관리자' : '사용자'} (${userId.substring(0, 6)}...)` : '로그인 필요';
            document.getElementById('profileUserId').textContent = `User ID: ${userId || 'N/A'}`;
            const adminUserIdDisplayEl = document.getElementById('adminUserIdDisplay');
            if(adminUserIdDisplayEl) { adminUserIdDisplayEl.classList.toggle('hidden', !isAdminMode); if(isAdminMode) adminUserIdDisplayEl.textContent = `관리자 모드 활성 (UID: ${userId})`;}

            setupAdminUI(); populateUploadFormOptions(); populateEditFormOptions(); 

            if (!appInitialized) {
                appInitialized = true;
                if (!currentUser && !(typeof __initial_auth_token !== 'undefined' && __initial_auth_token)) {
                    await attemptSignIn(); 
                } else { 
                    await initializeAppLogic(); 
                }
            } else if (userId !== previousUserId) { 
                loadAllDataAndRender();
            }
        });

        async function attemptSignIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else if (!auth.currentUser) { console.log("Admin app may require specific login."); }
            } catch (error) { console.error("Error during sign-in (Admin):", error); showToast("로그인 오류: " + error.message, true); }
        }

        async function initializeAppLogic() {
            await handleInitialDataImport(); setupEventListeners(); 
            if (userId) { loadAllDataAndRender(); }
        }
        async function handleInitialDataImport() { if (!isAdminMode) return; console.log("Admin mode: Initial data import placeholder.");}

        function setupAdminUI() {
            const uploadNavDesktop = document.querySelector('#desktopSidebar .nav-item[data-section="upload"]');
            const uploadNavMobile = document.querySelector('#mobileSidebar .nav-item[data-section="upload"]');
            if (uploadNavDesktop) uploadNavDesktop.style.display = isAdminMode ? 'flex' : 'none';
            if (uploadNavMobile) uploadNavMobile.style.display = isAdminMode ? 'flex' : 'none';
            if (!isAdminMode && document.getElementById('upload')?.classList.contains('active')) { switchSection('home'); }
        }

        function loadAllDataAndRender() {
            if (!userId) { /* Clear data and UI */ return; }
            if (unsubscribeContentItems) unsubscribeContentItems(); 
            // Data is fetched newest first
            unsubscribeContentItems = onSnapshot(query(collection(db, getContentItemsCollectionPath()), orderBy('createdAt', 'desc')), (snap) => {
                allContentData = snap.docs.map(d => ({ ...d.data(), itemId: d.id })); renderPageContent();
            }, (err) => { console.error("Error content (Admin):", err); showToast('콘텐츠 로딩 실패', true); });

            if (unsubscribePlaylists) unsubscribePlaylists();
            unsubscribePlaylists = onSnapshot(query(collection(db, getUserPlaylistsCollectionPath(userId)), orderBy('createdAt', 'desc')), (snap) => {
                userPlaylists = snap.docs.map(d => ({ ...d.data(), id: d.id })); renderMyPlaylists();
                if (currentViewingPlaylistId && playlistDetailModal && !playlistDetailModal.classList.contains('hidden')) {
                    const p = userPlaylists.find(pl => pl.id === currentViewingPlaylistId); if (p) openPlaylistDetailModal(currentViewingPlaylistId); else closePlaylistDetailModal();
                }
            }, (err) => { console.error("Error playlists (Admin):", err); });

            if (unsubscribeLikedItems) unsubscribeLikedItems();
            unsubscribeLikedItems = onSnapshot(collection(db, getUserLikedItemsCollectionPath(userId)), (snap) => {
                userLikedItemIds.clear(); snap.forEach(d => userLikedItemIds.add(d.id)); renderLikedSongs(); renderPageContent();
            }, (err) => { console.error("Error liked (Admin):", err);});

            if (unsubscribeSubscribedArtists) unsubscribeSubscribedArtists();
            unsubscribeSubscribedArtists = onSnapshot(collection(db, getUserSubscribedArtistsCollectionPath(userId)), (snap) => {
                userSubscribedArtists.clear(); snap.forEach(d => userSubscribedArtists.add(d.id)); renderSubscribedArtists(); renderPageContent();
            }, (err) => { console.error("Error subscribed (Admin):", err); });
        }
        
        const activeNavClass = 'neon-accent-bg', inactiveNavClass = 'hover:bg-purple-700/30';
        let desktopSidebar, mobileSidebar, mobileSidebarOverlay, mobileMenuButton, closeMobileSidebarButton, aionLogoDesktop, aionLogoMobile; 

        function initializeMenuElements() {
            desktopSidebar = desktopSidebar || document.getElementById('desktopSidebar'); mobileSidebar = mobileSidebar || document.getElementById('mobileSidebar');
            mobileSidebarOverlay = mobileSidebarOverlay || document.getElementById('mobileSidebarOverlay'); mobileMenuButton = mobileMenuButton || document.getElementById('mobileMenuButton');
            closeMobileSidebarButton = closeMobileSidebarButton || document.getElementById('closeMobileSidebarButton');
            aionLogoDesktop = aionLogoDesktop || document.getElementById('aionLogoDesktop'); aionLogoMobile = aionLogoMobile || document.getElementById('aionLogoMobile');
        }
        
        function setInitialActiveSection() {
            initializeMenuElements();
            document.querySelectorAll('.content-section').forEach(s => { s.style.display = 'none'; s.classList.remove('active'); });
            const homeSection = document.getElementById('home'); if (homeSection) { homeSection.classList.add('active'); homeSection.style.display = 'block'; } 
            updateNavActiveState('home');
        }
        
        function switchSection(sectionId) { 
            if (sectionId === 'upload' && !isAdminMode) { showToast("관리자만 접근 가능합니다.", true); switchSection('home'); return; }
            document.querySelectorAll('.content-section').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
            const targetSection = document.getElementById(sectionId); if (targetSection) { targetSection.style.display = 'block'; targetSection.classList.add('active'); }
            updateNavActiveState(sectionId);
        }

        function updateNavActiveState(activeSectionId) {
            initializeMenuElements();
            document.querySelectorAll('#desktopSidebar .nav-item, #mobileSidebar .nav-item').forEach(nav => {
                nav.classList.toggle(activeNavClass, nav.dataset.section === activeSectionId);
                nav.classList.toggle(inactiveNavClass, nav.dataset.section !== activeSectionId);
            });
        }

        function setupEventListeners() {
            initializeMenuElements(); setInitialActiveSection(); 
            document.querySelectorAll('#desktopSidebar .nav-item, #mobileSidebar .nav-item').forEach(item => {
                item.addEventListener('click', (e) => { e.preventDefault(); switchSection(item.dataset.section); if (mobileSidebar && !mobileSidebar.classList.contains('-translate-x-full')) closeMobileSidebar(); });
            });
            if (mobileMenuButton) mobileMenuButton.addEventListener('click', openMobileSidebar);
            if (closeMobileSidebarButton) closeMobileSidebarButton.addEventListener('click', closeMobileSidebar);
            if (mobileSidebarOverlay) mobileSidebarOverlay.addEventListener('click', closeMobileSidebar);
            if (aionLogoDesktop) aionLogoDesktop.addEventListener('click', (e) => { e.preventDefault(); switchSection('home'); });
            if (aionLogoMobile) aionLogoMobile.addEventListener('click', (e) => { e.preventDefault(); switchSection('home'); closeMobileSidebar(); });

            // Upload Form Listeners
            document.getElementById('uploadForm')?.addEventListener('submit', handleUploadFormSubmit);
            document.getElementById('uploadYoutubeLink')?.addEventListener('input', updateThumbnailPreviewFromUrlInput); 
            const uploadInputsToWatch = ['uploadYoutubeLink', 'uploadTitle', 'uploadContentType', 'uploadAiMusicArtist', 'uploadSingerName', 'uploadAiTool'];
            uploadInputsToWatch.forEach(id => document.getElementById(id)?.addEventListener('input', updateUploadTagsFromSelections));
            document.getElementById('uploadIsInstrumental')?.addEventListener('change', updateUploadTagsFromSelections);
            ['uploadThemesContainer', 'uploadGenresContainer', 'uploadMoodsContainer'].forEach(id => document.getElementById(id)?.addEventListener('change', updateUploadTagsFromSelections));
            document.getElementById('uploadTags')?.addEventListener('input', () => updateUploadTagsFromSelections(true)); 
            document.getElementById('uploadContentType')?.addEventListener('change', toggleUploadFields);
            toggleUploadFields(); 
            document.getElementById('cancelUploadButton')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('uploadForm').reset();
                updateThumbnailPreview('', 'thumbnailPreview');
                updateUploadTagsFromSelections(); 
                toggleUploadFields(); 
                switchSection('home');
            });


            // Edit Form Listeners
            document.getElementById('editItemForm')?.addEventListener('submit', handleEditFormSubmit);
            document.getElementById('editYoutubeLink')?.addEventListener('input', updateEditThumbnailPreviewFromUrlInput); 
            const editInputsToWatch = ['editYoutubeLink', 'editTitle', 'editContentType', 'editAiMusicArtist', 'editSingerName', 'editAiTool'];
            editInputsToWatch.forEach(id => document.getElementById(id)?.addEventListener('input', updateEditTagsFromSelections));
            document.getElementById('editIsInstrumental')?.addEventListener('change', updateEditTagsFromSelections);
            ['editThemesContainer', 'editGenresContainer', 'editMoodsContainer'].forEach(id => document.getElementById(id)?.addEventListener('change', updateEditTagsFromSelections));
            document.getElementById('editTags')?.addEventListener('input', () => updateEditTagsFromSelections(true)); 
            document.getElementById('editContentType')?.addEventListener('change', toggleEditFields);
            
            document.getElementById('cancelEditItemButtonInModal')?.addEventListener('click', (e) => { 
                e.preventDefault(); 
                closeEditModal(); 
            });
            const cancelEditButtonBottom = document.querySelector('#editItemForm #cancelEditItemButtonInModalClose'); 
            if (cancelEditButtonBottom) {
                 cancelEditButtonBottom.addEventListener('click', (e) => { e.preventDefault(); closeEditModal(); });
            }
            
            // Other Modals and Global
            document.getElementById('closeYoutubeModalButton')?.addEventListener('click', closeYoutubeModal);
            document.getElementById('youtubeModal')?.addEventListener('click', (event) => { if (event.target === document.getElementById('youtubeModal')) closeYoutubeModal(); });
            document.getElementById('createPlaylistButton')?.addEventListener('click', () => openCreatePlaylistModal());
            document.getElementById('cancelCreatePlaylist')?.addEventListener('click', () => closeCreatePlaylistModal());
            document.getElementById('confirmCreatePlaylist')?.addEventListener('click', handleConfirmCreatePlaylist);
            document.getElementById('cancelAddToPlaylist')?.addEventListener('click', () => closeAddToPlaylistModal());
            document.getElementById('confirmAddToPlaylist')?.addEventListener('click', handleConfirmAddToPlaylist);
            document.getElementById('closePlaylistDetailModal')?.addEventListener('click', () => closePlaylistDetailModal());
            document.getElementById('deletePlaylistButton')?.addEventListener('click', handleDeletePlaylist);
            document.body.addEventListener('click', handleContentInteraction);
        }

        function openMobileSidebar() { if (mobileSidebar && mobileSidebarOverlay) { mobileSidebar.classList.remove('-translate-x-full'); mobileSidebarOverlay.classList.remove('hidden'); } }
        function closeMobileSidebar() { if (mobileSidebar && mobileSidebarOverlay) { mobileSidebar.classList.add('-translate-x-full'); mobileSidebarOverlay.classList.add('hidden'); } }

        const defaultThumbnail = 'https://placehold.co/320x180/1A0933/4A2270?text=썸네일+미리보기';
        const thumbnailErrorPlaceholder = 'https://placehold.co/300x180/330033/FFFFFF?text=썸네일+오류';
        function getYouTubeId(url) { if (!url) return ''; let videoId = ''; const patterns = [ /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^& \n<]{11})/, /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^? \n<]{11})/, /(?:https?:\/\/)?youtu\.be\/([^? \n<]{11})/, ]; for (const pattern of patterns) { const match = url.match(pattern); if (match && match[1]) { videoId = match[1]; break; } } return videoId; }
        function getYouTubeThumbnailUrl(videoId) { return videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : defaultThumbnail; }
        function updateThumbnailPreview(url, previewElId) { const el = document.getElementById(previewElId); if (el) { el.src = getYouTubeThumbnailUrl(getYouTubeId(url)); el.onerror = () => { el.src = defaultThumbnail; }; } }
        function updateThumbnailPreviewFromUrlInput() { updateThumbnailPreview(document.getElementById('uploadYoutubeLink').value, 'thumbnailPreview'); }
        function updateEditThumbnailPreviewFromUrlInput() { updateThumbnailPreview(document.getElementById('editYoutubeLink').value, 'editThumbnailPreview'); }
        const toastMessageElement = document.getElementById('toastMessage');
        function showToast(message, isError = false) { if (!toastMessageElement) return; toastMessageElement.textContent = message; toastMessageElement.className = `toast-message show ${isError ? 'bg-red-600' : 'neon-accent-bg'}`; setTimeout(() => { toastMessageElement.classList.remove('show'); }, 3000); }

        const newUploadsContainer = document.getElementById('newUploadsContainer'), newUploadsPlaceholder = document.getElementById('newUploadsPlaceholder');
        const aionChartContainer = document.getElementById('aionChartContainer'), aionChartPlaceholder = document.getElementById('aionChartPlaceholder');
        const recommendedMusicContainer = document.getElementById('recommendedMusicContainer'), recommendedMusicPlaceholder = document.getElementById('recommendedMusicPlaceholder');

        function createContentItemHTML(itemData) {
            let titleWithViewsHTML = `<h4 class="item-title truncate">${itemData.title || '제목 없음'}</h4>`;
            if (typeof itemData.views === 'number') {
                titleWithViewsHTML = `<div class="flex items-center justify-between"><h4 class="item-title truncate flex-grow">${itemData.title || '제목 없음'}</h4><span class="text-yellow-300 ml-1 text-xs whitespace-nowrap"><i class="fas fa-eye text-xs"></i> ${itemData.views}</span></div>`;
            }

            const categoryTagsArray = [];
            if (itemData.themes && Array.isArray(itemData.themes) && itemData.themes.length > 0) {
                itemData.themes.forEach(t => categoryTagsArray.push(`#${t.trim()}`));
            }
            if (itemData.genres && Array.isArray(itemData.genres) && itemData.genres.length > 0) {
                itemData.genres.forEach(g => categoryTagsArray.push(`#${g.trim()}`));
            }
            if (itemData.moods && Array.isArray(itemData.moods) && itemData.moods.length > 0) {
                itemData.moods.forEach(m => categoryTagsArray.push(`#${m.trim()}`));
            }
            const categoryTagsHTML = categoryTagsArray.join(' ');

            let actionButtonsHTML = `<div class="item-action-icon-wrapper">`;
            if (userId && !userId.startsWith('guest-')) {
                actionButtonsHTML += `<i class="fas fa-list-ul item-action-icon add-to-playlist-icon" title="플레이리스트에 추가"></i>`;
                const isLiked = userLikedItemIds.has(itemData.itemId);
                actionButtonsHTML +=`<i class="${isLiked ? 'fas fa-heart text-red-500' : 'far fa-heart'} item-action-icon like-item-button" title="${isLiked ? '좋아요 취소' : '좋아요'}"></i>`;
            }
            if (isAdminMode) { 
                actionButtonsHTML += `<i class="fas fa-edit item-action-icon edit-item-button" title="수정"></i>`;
                actionButtonsHTML += `<i class="fas fa-trash-alt item-action-icon delete-item-button" title="삭제"></i>`;
                actionButtonsHTML += `<i class="fas fa-star item-action-icon recommend-checkbox-icon ${itemData.isRecommended ? 'text-yellow-400' : 'text-gray-400'}" title="${itemData.isRecommended ? '추천 해제' : '추천 설정'}"></i>`;
            }
            actionButtonsHTML += `</div>`;
            
            let artistsHTML = '';
            const createArtistHTML = (name, type) => {
                if (!name || name === 'N/A') return '';
                const isSubscribed = userSubscribedArtists.has(name);
                const typeLabel = type === 'singer' ? '가수: ' : (type === 'ai-artist' ? 'AI 아티스트: ' : (type === 'ai-tool' ? 'AI 도구: ' : ''));
                return `<div class="item-artist-wrapper text-gray-400 truncate">
                            <span class="mr-1 item-title">${typeLabel}${name}</span> 
                            ${userId && !userId.startsWith('guest-') ? 
                                `<i class="${isSubscribed ? 'fas fa-heart text-red-500' : 'far fa-heart'} subscribe-artist-icon cursor-pointer ml-1 text-xs" data-artist-name="${name}" title="${isSubscribed ? name + ' 구독 취소' : name + ' 구독'}"></i>` 
                                : ''}
                        </div>`;
            };

            if (itemData.singerName && itemData.singerName !== 'N/A') {
                artistsHTML += createArtistHTML(itemData.singerName, 'singer');
            }
            if (itemData.aiMusicArtist && itemData.aiMusicArtist !== 'N/A') {
                 artistsHTML += createArtistHTML(itemData.aiMusicArtist, 'ai-artist');
            }
            if (itemData.aiTool && itemData.aiTool !== 'N/A' && itemData.contentType === 'ai-mv') { 
                 artistsHTML += createArtistHTML(itemData.aiTool, 'ai-tool');
            }
            
            if (!artistsHTML) { 
                artistsHTML = `<div class="item-artist-wrapper"><p class="item-artist text-gray-400 truncate">N/A</p></div>`;
            }
            
            return `${actionButtonsHTML}<div class="thumbnail-image-container mb-1"><img src="${getYouTubeThumbnailUrl(itemData.youtubeId)}" alt="${itemData.title}" class="thumbnail-image h-full" onerror="this.onerror=null;this.src='${thumbnailErrorPlaceholder}';"></div>${titleWithViewsHTML}${artistsHTML}<span class="item-tags neon-accent">${categoryTagsHTML}</span>`;
        }

        // *** MODIFIED FUNCTION ***
        // This function creates a DOM element for a content item and appends it to the given container.
        // The order of items in `allContentData` (newest first) will be preserved visually.
        function renderContentItem(itemData, container) { 
            if (!container) return; 
            const newItemDiv = document.createElement('div');
            newItemDiv.className = 'youtube-playable glassmorphism p-2 sm:p-3 rounded-lg hover:shadow-lg hover:shadow-purple-500/30 transition-shadow cursor-pointer flex flex-col'; 
            newItemDiv.dataset.youtubeId = itemData.youtubeId; 
            newItemDiv.dataset.itemId = itemData.itemId;
            newItemDiv.innerHTML = createContentItemHTML(itemData);
            container.appendChild(newItemDiv); // Always append. This ensures newest items (first in allContentData) appear first.
        }
        // *** END OF MODIFIED FUNCTION ***

        function clearContainer(container, placeholder) { if (!container) return; Array.from(container.children).filter(c => c !== placeholder).forEach(c => container.removeChild(c)); }
        function renderPageContent() { renderNewUploadsSection(); renderAionChart(); renderRecommendedMusicSection(); }
        
        // This function renders the "New AI Music & MV" section.
        // It iterates `allContentData` (which is newest to oldest) and calls `renderContentItem`.
        // With the modified `renderContentItem`, items will be appended, resulting in newest items appearing first.
        function renderNewUploadsSection() { 
            if (!newUploadsContainer) return; 
            clearContainer(newUploadsContainer, newUploadsPlaceholder); 
            if (allContentData.length > 0) { 
                if(newUploadsPlaceholder) newUploadsPlaceholder.classList.add('hidden'); 
                allContentData.forEach(item => renderContentItem(item, newUploadsContainer)); 
            } else { 
                if(newUploadsPlaceholder) { 
                    newUploadsPlaceholder.classList.remove('hidden'); 
                    newUploadsPlaceholder.textContent = "업로드된 콘텐츠가 없습니다."; 
                } 
            } 
        }

        function renderRecommendedMusicSection() { if (!recommendedMusicContainer) return; clearContainer(recommendedMusicContainer, recommendedMusicPlaceholder); const items = allContentData.filter(item => item.isRecommended); if (items.length > 0) { if(recommendedMusicPlaceholder) recommendedMusicPlaceholder.classList.add('hidden'); items.forEach(item => renderContentItem(item, recommendedMusicContainer)); } else { if(recommendedMusicPlaceholder) { recommendedMusicPlaceholder.classList.remove('hidden'); recommendedMusicPlaceholder.textContent = "추천 음악이 없습니다."; } } }
        function renderAionChart() { if (!aionChartContainer) return; clearContainer(aionChartContainer, aionChartPlaceholder); const items = [...allContentData].filter(i => (i.views || 0) > 0).sort((a,b) => (b.views||0) - (a.views||0)).slice(0,10); if (items.length > 0) { if(aionChartPlaceholder) aionChartPlaceholder.classList.add('hidden'); items.forEach(item => renderContentItem(item, aionChartContainer)); } else { if(aionChartPlaceholder) { aionChartPlaceholder.classList.remove('hidden'); aionChartPlaceholder.textContent = "차트 데이터가 없습니다."; } } }
        
        const editItemModal = document.getElementById('editItemModal');
        let currentEditingItemId = null;

        function getFormValues(formPrefix) {
            const title = document.getElementById(`${formPrefix}Title`)?.value.trim();
            const youtubeLink = document.getElementById(`${formPrefix}YoutubeLink`)?.value.trim();
            const contentType = document.getElementById(`${formPrefix}ContentType`)?.value;
            const themes = Array.from(document.querySelectorAll(`#${formPrefix}ThemesContainer input:checked`)).map(cb => cb.value);
            const genres = Array.from(document.querySelectorAll(`#${formPrefix}GenresContainer input:checked`)).map(cb => cb.value);
            const moods = Array.from(document.querySelectorAll(`#${formPrefix}MoodsContainer input:checked`)).map(cb => cb.value);
            const isInstrumental = document.getElementById(`${formPrefix}IsInstrumental`)?.checked || false;
            const aiMusicArtist = document.getElementById(`${formPrefix}AiMusicArtist`)?.value.trim();
            const singerName = document.getElementById(`${formPrefix}SingerName`)?.value.trim();
            const aiTool = document.getElementById(`${formPrefix}AiTool`)?.value.trim();
            
            const autoGeneratedTags = new Set(); 
            if (title) autoGeneratedTags.add(title);
            if (contentType) autoGeneratedTags.add(contentType); 
            if (document.getElementById(`${formPrefix}AiMusicArtistContainer`) && !document.getElementById(`${formPrefix}AiMusicArtistContainer`).classList.contains('hidden') && aiMusicArtist) autoGeneratedTags.add(aiMusicArtist);
            if (document.getElementById(`${formPrefix}SingerNameContainer`) && !document.getElementById(`${formPrefix}SingerNameContainer`).classList.contains('hidden') && singerName) autoGeneratedTags.add(singerName);
            if (document.getElementById(`${formPrefix}AiToolContainer`) && !document.getElementById(`${formPrefix}AiToolContainer`).classList.contains('hidden') && aiTool) autoGeneratedTags.add(aiTool);
            if (isInstrumental) autoGeneratedTags.add("Instrumental");
            themes.forEach(t => autoGeneratedTags.add(t));
            genres.forEach(g => autoGeneratedTags.add(g));
            moods.forEach(m => autoGeneratedTags.add(m));

            const allTagsFromInputString = document.getElementById(`${formPrefix}Tags`)?.value.trim() || "";
            const allTagsFromInputArray = allTagsFromInputString ? allTagsFromInputString.split(',').map(t => t.trim()).filter(t => t) : [];
            const trulyManualTagsToSave = allTagsFromInputArray.filter(tag => !autoGeneratedTags.has(tag));

            return {
                title, youtubeLink, contentType, themes, genres, moods, 
                tags: trulyManualTagsToSave.join(','), 
                isInstrumental, aiMusicArtist, singerName, aiTool,
                youtubeId: getYouTubeId(youtubeLink)
            };
        }


        async function handleUploadFormSubmit(event) {
            event.preventDefault();
            if (!isAdminMode) { showToast("관리자만 업로드할 수 있습니다.", true); return; }
            const formValues = getFormValues('upload');
            if (!formValues.title || !formValues.youtubeLink || !formValues.contentType) { showToast("필수 항목(제목, YouTube 링크, 콘텐츠 유형)을 입력해주세요.", true); return; }
            if (!formValues.youtubeId) { showToast("유효한 YouTube 링크를 입력해주세요.", true); return; }

            const newItemData = {
                title: formValues.title, youtubeId: formValues.youtubeId, contentType: formValues.contentType, 
                themes: formValues.themes, genres: formValues.genres, moods: formValues.moods,   
                tags: formValues.tags, isInstrumental: formValues.isInstrumental,
                aiMusicArtist: (formValues.contentType === 'ai-music' && formValues.aiMusicArtist) ? formValues.aiMusicArtist : null,
                singerName: (formValues.contentType === 'ai-music' || formValues.contentType === 'general-music') && formValues.singerName ? formValues.singerName : null,
                aiTool: (formValues.contentType === 'ai-mv' && formValues.aiTool) ? formValues.aiTool : null,
                views: 0, isRecommended: false, createdAt: serverTimestamp(), uploaderId: userId
            };
            try {
                await addDoc(collection(db, getContentItemsCollectionPath()), newItemData);
                showToast("콘텐츠가 성공적으로 업로드되었습니다!");
                document.getElementById('uploadForm').reset();
                updateThumbnailPreview('', 'thumbnailPreview'); 
                updateUploadTagsFromSelections(); toggleUploadFields(); 
                switchSection('home'); 
            } catch (error) { console.error("Error uploading (Admin):", error); showToast("업로드 오류: " + error.message, true); }
        }
        
        async function handleEditFormSubmit(event) {
            event.preventDefault();
            if (!isAdminMode || !currentEditingItemId) { showToast("수정 권한/대상이 없습니다.", true); return; }
            const formValues = getFormValues('edit');
            if (!formValues.title || !formValues.youtubeLink || !formValues.contentType) { showToast("제목, YouTube 링크, 콘텐츠 유형은 필수입니다.", true); return; }
            if (!formValues.youtubeId) { showToast("유효한 YouTube 링크를 입력해주세요.", true); return; }

            const itemToEdit = allContentData.find(item => item.itemId === currentEditingItemId);
            if (!itemToEdit) { showToast("수정할 항목을 찾을 수 없습니다.", true); return; }

            const updatedItemData = {
                title: formValues.title, youtubeId: formValues.youtubeId, contentType: formValues.contentType,
                themes: formValues.themes, genres: formValues.genres, moods: formValues.moods,
                tags: formValues.tags, isInstrumental: formValues.isInstrumental,
                aiMusicArtist: (formValues.contentType === 'ai-music' && formValues.aiMusicArtist) ? formValues.aiMusicArtist : null,
                singerName: (formValues.contentType === 'ai-music' || formValues.contentType === 'general-music') && formValues.singerName ? formValues.singerName : null,
                aiTool: (formValues.contentType === 'ai-mv' && formValues.aiTool) ? formValues.aiTool : null,
                isRecommended: itemToEdit.isRecommended || false 
            };
            try {
                await updateDoc(doc(db, getContentItemsCollectionPath(), currentEditingItemId), updatedItemData);
                showToast("콘텐츠가 성공적으로 수정되었습니다!"); closeEditModal();
            } catch (error) { console.error("Error updating (Admin):", error); showToast("수정 오류: " + error.message, true); }
        }

        const youtubeModal = document.getElementById('youtubeModal');

        async function handleContentInteraction(event) {
            if (!appInitialized) return;
            const target = event.target;
            const playableItem = target.closest('.youtube-playable');
            const actionMappings = {
                '.add-to-playlist-icon': () => { if (!userId || userId.startsWith('guest-')) { showToast("로그인 필요", true); return; } currentItemToAddToPlaylist = playableItem?.dataset.itemId; if (currentItemToAddToPlaylist) openAddToPlaylistModal(); },
                '.subscribe-artist-icon': async () => { 
                    if (!userId || userId.startsWith('guest-')) { showToast("로그인 필요", true); return; } 
                    const artistName = target.dataset.artistName; 
                    if (artistName && artistName !== 'N/A') await toggleArtistSubscription(artistName); 
                },
                '.like-item-button': async () => { if (!userId || userId.startsWith('guest-')) { showToast("로그인 필요", true); return; } const itemId = playableItem?.dataset.itemId; if(itemId) await toggleLikeItem(itemId); },
                '.edit-item-button': () => { if (isAdminMode) { const itemId = playableItem?.dataset.itemId; if (itemId) openEditModalWithData(itemId); } },
                '.delete-item-button': () => { if (isAdminMode) { const itemId = playableItem?.dataset.itemId; if (itemId) deleteContentItem(itemId); } },
                '.recommend-checkbox-icon': () => { if (isAdminMode) { const itemId = playableItem?.dataset.itemId; if (itemId) toggleRecommendation(itemId); } }
            };
            for (const selector in actionMappings) {
                if (target.closest(selector) || target.matches(selector)) { 
                     event.stopPropagation(); actionMappings[selector](); return; 
                }
            }
            if (playableItem) { const { youtubeId, itemId } = playableItem.dataset; if (youtubeId && itemId) openYoutubeModal(youtubeId, itemId); }
        }
        
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                closeYoutubeModal();
            }
        }

        function openYoutubeModal(youtubeId, itemId) {
            if (!youtubeModal) return;
            if (ytPlayerInstance) {
                ytPlayerInstance.destroy();
                ytPlayerInstance = null;
            }
            const playerDiv = document.getElementById('youtubePlayer');
            if (playerDiv) playerDiv.innerHTML = '';


            ytPlayerInstance = new YT.Player('youtubePlayer', {
                height: '100%',
                width: '100%',
                videoId: youtubeId,
                playerVars: {
                    'autoplay': 1,
                    'rel': 0, 
                    'controls': 1 
                },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
            youtubeModal.classList.remove('hidden');
            youtubeModal.classList.add('flex');
            incrementViewCount(itemId);
        }

        function closeYoutubeModal() {
            if (ytPlayerInstance) {
                ytPlayerInstance.stopVideo();
                ytPlayerInstance.destroy(); 
                ytPlayerInstance = null;
            }
            if (youtubeModal) {
                youtubeModal.classList.add('hidden');
                youtubeModal.classList.remove('flex');
                const playerDiv = document.getElementById('youtubePlayer');
                if (playerDiv) playerDiv.innerHTML = '';
            }
        }

        async function incrementViewCount(itemId) { if (!itemId) return; try { await updateDoc(doc(db, getContentItemsCollectionPath(), itemId), { views: increment(1) }); } catch (e) { console.error('Err incrementing views:', e); } }

        function openEditModalWithData(itemId) {
            if (!isAdminMode || !editItemModal) return;
            const item = allContentData.find(i => i.itemId === itemId);
            if (!item) { showToast("수정할 항목을 찾을 수 없습니다.", true); return; }
            currentEditingItemId = itemId;
            document.getElementById('editTitle').value = item.title || '';
            document.getElementById('editYoutubeLink').value = item.youtubeId ? `https://www.youtube.com/watch?v=${item.youtubeId}` : '';
            updateThumbnailPreview(item.youtubeId ? `https://www.youtube.com/watch?v=${item.youtubeId}` : '', 'editThumbnailPreview');
            document.getElementById('editContentType').value = item.contentType || '';
            toggleEditFields(); 
            populateCheckboxGroup('editThemesContainer', predefinedThemes, 'editTheme', item.themes || []);
            populateCheckboxGroup('editGenresContainer', predefinedGenres, 'editGenre', item.genres || []);
            populateCheckboxGroup('editMoodsContainer', predefinedMoods, 'editMood', item.moods || []);
            document.getElementById('editTags').value = item.tags || ''; 
            updateEditTagsFromSelections(); 
            document.getElementById('editIsInstrumental').checked = item.isInstrumental || false;
            if(document.getElementById('editAiMusicArtist')) document.getElementById('editAiMusicArtist').value = item.aiMusicArtist || '';
            if(document.getElementById('editSingerName')) document.getElementById('editSingerName').value = item.singerName || '';
            if(document.getElementById('editAiTool')) document.getElementById('editAiTool').value = item.aiTool || '';
            editItemModal.classList.remove('hidden');
        }
        function closeEditModal() { if (editItemModal) { editItemModal.classList.add('hidden'); currentEditingItemId = null; } }
        
        async function deleteContentItem(itemIdToDelete) {
            if (!isAdminMode || !itemIdToDelete) return;
            if (await showConfirmationModal("콘텐츠 삭제하시겠습니까?")) {
                try { await deleteDoc(doc(db, getContentItemsCollectionPath(), itemIdToDelete)); showToast("콘텐츠 삭제됨."); } 
                catch (e) { console.error("Error deleting (Admin):", e); showToast("삭제 오류: " + e.message, true); }
            }
        }
        async function toggleRecommendation(itemId) {
            if (!isAdminMode || !itemId) return; const item = allContentData.find(i => i.itemId === itemId); if (!item) return;
            try { await updateDoc(doc(db, getContentItemsCollectionPath(), itemId), { isRecommended: !item.isRecommended }); showToast(item.isRecommended ? "추천 해제" : "추천 설정"); } 
            catch (e) { console.error("Error recommending (Admin):", e); showToast("추천 변경 오류", true); }
        }

        function toggleUploadFields() {
            const contentType = document.getElementById('uploadContentType').value;
            const artistContainer = document.getElementById('uploadAiMusicArtistContainer');
            const singerContainer = document.getElementById('uploadSingerNameContainer');
            const toolContainer = document.getElementById('uploadAiToolContainer');
            [artistContainer, singerContainer, toolContainer].forEach(c => c?.classList.add('hidden'));
            if (contentType === 'ai-music') { artistContainer?.classList.remove('hidden'); singerContainer?.classList.remove('hidden'); } 
            else if (contentType === 'general-music') { singerContainer?.classList.remove('hidden'); } 
            else if (contentType === 'ai-mv') { toolContainer?.classList.remove('hidden'); }
        }

        function toggleEditFields() {
            const contentType = document.getElementById('editContentType').value;
            const artistContainer = document.getElementById('editAiMusicArtistContainer');
            const singerContainer = document.getElementById('editSingerNameContainer');
            const toolContainer = document.getElementById('editAiToolContainer');
            [artistContainer, singerContainer, toolContainer].forEach(c => c?.classList.add('hidden'));
            if (contentType === 'ai-music') { artistContainer?.classList.remove('hidden'); singerContainer?.classList.remove('hidden'); } 
            else if (contentType === 'general-music') { singerContainer?.classList.remove('hidden'); } 
            else if (contentType === 'ai-mv') { toolContainer?.classList.remove('hidden'); }
        }
        
        const myPlaylistsContainer = document.getElementById('myPlaylistsContainer'), myPlaylistsPlaceholder = document.getElementById('myPlaylistsPlaceholder');
        const createPlaylistModal = document.getElementById('createPlaylistModal'), newPlaylistNameInput = document.getElementById('newPlaylistName');
        const addToPlaylistModal = document.getElementById('addToPlaylistModal'), playlistSelectionContainer = document.getElementById('playlistSelectionContainer');
        const playlistSelectionPlaceholder = document.getElementById('playlistSelectionPlaceholder'), newPlaylistNameInAddModalInput = document.getElementById('newPlaylistNameInAddModal');
        const playlistDetailModal = document.getElementById('playlistDetailModal'), playlistDetailNameElement = document.getElementById('playlistDetailName');
        const playlistDetailItemsContainer = document.getElementById('playlistDetailItemsContainer'), playlistDetailPlaceholder = document.getElementById('playlistDetailPlaceholder');
        let currentViewingPlaylistId = null;
        let currentItemToAddToPlaylist = null; // Added to store item ID for playlist addition

        function openCreatePlaylistModal() { if (!userId || userId.startsWith('guest-')) { showToast("로그인 필요", true); return; } if (createPlaylistModal) createPlaylistModal.classList.remove('hidden'); if (newPlaylistNameInput) newPlaylistNameInput.value = ''; }
        function closeCreatePlaylistModal() { if (createPlaylistModal) createPlaylistModal.classList.add('hidden'); }
        async function handleConfirmCreatePlaylist() { if (!userId || userId.startsWith('guest-')) { showToast("로그인 필요", true); return; } const name = newPlaylistNameInput.value.trim(); if (name) { try { await addDoc(collection(db, getUserPlaylistsCollectionPath(userId)), { name, items: [], ownerId: userId, createdAt: serverTimestamp() }); closeCreatePlaylistModal(); showToast(`'${name}' 생성됨.`); } catch (e) { console.error("Err creating playlist:", e); showToast("생성 오류.", true); } } else { showToast('이름 입력 필요.', true); } }
        function openAddToPlaylistModal() { if (!userId || userId.startsWith('guest-')) { showToast("로그인 필요", true); return; } if (!addToPlaylistModal || !playlistSelectionContainer || !playlistSelectionPlaceholder) return; playlistSelectionContainer.innerHTML = ''; if (userPlaylists.length > 0) { if (playlistSelectionPlaceholder) playlistSelectionPlaceholder.classList.add('hidden'); userPlaylists.forEach(pl => { const div = document.createElement('div'); div.className = 'flex items-center space-x-2 p-2 hover:bg-purple-700/30 rounded-md cursor-pointer'; div.dataset.playlistId = pl.id; const input = document.createElement('input'); input.type = 'radio'; input.name = 'playlistSelection'; input.value = pl.id; input.className = 'form-radio h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 focus:ring-purple-500'; input.id = `pl-select-${pl.id}`; const label = document.createElement('label'); label.htmlFor = `pl-select-${pl.id}`; label.textContent = pl.name; label.className = 'text-sm flex-grow cursor-pointer'; div.append(input, label); div.addEventListener('click', () => { input.checked = true; }); playlistSelectionContainer.appendChild(div); }); } else { if (playlistSelectionPlaceholder) playlistSelectionPlaceholder.classList.remove('hidden'); } if (newPlaylistNameInAddModalInput) newPlaylistNameInAddModalInput.value = ''; addToPlaylistModal.classList.remove('hidden'); }
        function closeAddToPlaylistModal() { if (addToPlaylistModal) addToPlaylistModal.classList.add('hidden'); currentItemToAddToPlaylist = null; }
        async function handleConfirmAddToPlaylist() { if (!userId || userId.startsWith('guest-') || !currentItemToAddToPlaylist) return; const selRadio = playlistSelectionContainer.querySelector('input:checked'); const newName = newPlaylistNameInAddModalInput.value.trim(); let nameToast = ""; try { if (newName) { await addDoc(collection(db, getUserPlaylistsCollectionPath(userId)), { name: newName, items: [currentItemToAddToPlaylist], ownerId: userId, createdAt: serverTimestamp() }); nameToast = newName; showToast(`'${nameToast}'에 추가됨.`); } else if (selRadio) { const plId = selRadio.value; const pl = userPlaylists.find(p => p.id === plId); if (pl) { nameToast = pl.name; if (!pl.items.includes(currentItemToAddToPlaylist)) { await updateDoc(doc(db, getUserPlaylistsCollectionPath(userId), plId), { items: [...pl.items, currentItemToAddToPlaylist] }); showToast(`'${nameToast}'에 추가됨.`); } else { showToast('이미 있는 곡.'); } } else { showToast('플레이리스트 없음.', true); return; } } else { showToast('선택 또는 새 이름 입력.', true); return; } closeAddToPlaylistModal(); } catch (e) { console.error("Err adding to playlist:", e); showToast("추가 오류.", true); } }
        function renderMyPlaylists() { if (!myPlaylistsContainer || !myPlaylistsPlaceholder) return; clearContainer(myPlaylistsContainer, myPlaylistsPlaceholder); if (!userId || userId.startsWith('guest-')) { if(myPlaylistsPlaceholder) { myPlaylistsPlaceholder.classList.remove('hidden'); myPlaylistsPlaceholder.textContent = "로그인 필요."; } return; } if (userPlaylists.length > 0) { if(myPlaylistsPlaceholder) myPlaylistsPlaceholder.classList.add('hidden'); userPlaylists.forEach(pl => { const card = document.createElement('div'); card.className = 'playlist-card glassmorphism cursor-pointer'; card.dataset.playlistId = pl.id; const cover = document.createElement('div'); cover.className = 'playlist-cover'; if (pl.items && pl.items.length > 0) { const item = allContentData.find(i => i.itemId === pl.items[0]); if (item && item.youtubeId) { const img = document.createElement('img'); img.src = getYouTubeThumbnailUrl(item.youtubeId); img.alt = pl.name; img.className = 'w-full h-full object-cover rounded-md'; img.onerror = function() { this.parentElement.innerHTML = '<i class="fas fa-music text-3xl"></i>'; }; cover.appendChild(img); } else { cover.innerHTML = '<i class="fas fa-music text-3xl"></i>'; } } else { cover.innerHTML = '<i class="fas fa-music text-3xl"></i>'; } const info = document.createElement('div'); info.className = 'flex-grow'; const name = document.createElement('h4'); name.className = 'font-semibold text-sm truncate'; name.textContent = pl.name; const count = document.createElement('p'); count.className = 'text-xs text-gray-400'; count.textContent = `${(pl.items || []).length}곡`; info.append(name, count); card.append(cover, info); card.addEventListener('click', () => openPlaylistDetailModal(pl.id)); myPlaylistsContainer.appendChild(card); }); } else { if(myPlaylistsPlaceholder) { myPlaylistsPlaceholder.classList.remove('hidden'); myPlaylistsPlaceholder.textContent = "플레이리스트 없음."; } } }
        
        function openPlaylistDetailModal(playlistId) { 
            currentViewingPlaylistId = playlistId; 
            const pl = userPlaylists.find(p => p.id === playlistId); 
            if (!pl || !playlistDetailModal || !playlistDetailNameElement || !playlistDetailItemsContainer || !playlistDetailPlaceholder) return; 
            playlistDetailNameElement.textContent = pl.name; 
            clearContainer(playlistDetailItemsContainer, playlistDetailPlaceholder); 
            if (pl.items && pl.items.length > 0) { 
                if(playlistDetailPlaceholder) playlistDetailPlaceholder.classList.add('hidden'); 
                pl.items.forEach(itemId => { 
                    const item = allContentData.find(i => i.itemId === itemId); 
                    if (item) { 
                        const div = document.createElement('div'); 
                        div.className = 'glassmorphism p-3 rounded-lg flex items-center justify-between hover:bg-purple-700/20'; 
                        const img = document.createElement('img'); 
                        img.src = getYouTubeThumbnailUrl(item.youtubeId); 
                        img.alt = item.title; 
                        img.className = 'w-12 h-12 object-cover rounded-md mr-3 cursor-pointer'; 
                        img.onerror = function() { this.src = thumbnailErrorPlaceholder; }; 
                        const playAction = (e) => {
                            e.stopPropagation(); 
                            openYoutubeModal(item.youtubeId, item.itemId);
                            closePlaylistDetailModal(); 
                        };
                        img.addEventListener('click', playAction); 
                        const textInfo = document.createElement('div'); 
                        textInfo.className = 'flex-grow cursor-pointer'; 
                        textInfo.addEventListener('click', playAction); 
                        const titleH5 = document.createElement('h5'); 
                        titleH5.className = 'item-title truncate'; 
                        titleH5.textContent = item.title; 
                        const artistP = document.createElement('p'); 
                        artistP.className = 'item-artist text-gray-400 truncate'; 
                        artistP.textContent = item.singerName || item.aiMusicArtist || item.aiTool || 'N/A'; 
                        textInfo.append(titleH5, artistP); 
                        const actions = document.createElement('div'); 
                        actions.className = 'flex items-center'; 
                        const removeBtn = document.createElement('button'); 
                        removeBtn.className = 'p-2 text-red-400 hover:text-red-600 ml-2'; 
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>'; 
                        removeBtn.title = "플레이리스트에서 삭제"; 
                        removeBtn.addEventListener('click', async (e) => { e.stopPropagation(); await removeSongFromPlaylist(playlistId, item.itemId); }); 
                        actions.appendChild(removeBtn); 
                        div.append(img, textInfo, actions); 
                        playlistDetailItemsContainer.appendChild(div); 
                    } 
                }); 
            } else { 
                if(playlistDetailPlaceholder) { 
                    playlistDetailPlaceholder.classList.remove('hidden'); 
                    playlistDetailPlaceholder.textContent = "곡 없음."; 
                } 
            } 
            playlistDetailModal.classList.remove('hidden'); 
        }

        function closePlaylistDetailModal() { if(playlistDetailModal) playlistDetailModal.classList.add('hidden'); currentViewingPlaylistId = null; }
        async function handleDeletePlaylist() { if (!userId || userId.startsWith('guest-') || !currentViewingPlaylistId) return; const pl = userPlaylists.find(p => p.id === currentViewingPlaylistId); if (pl) { if (await showConfirmationModal(`'${pl.name}' 삭제?`)) { try { await deleteDoc(doc(db, getUserPlaylistsCollectionPath(userId), currentViewingPlaylistId)); closePlaylistDetailModal(); showToast('플레이리스트 삭제됨.'); } catch (e) { console.error("Err deleting playlist:", e); showToast("삭제 오류.", true); } } } else { showToast("플레이리스트 없음.", true); } }
        function showConfirmationModal(message) { return new Promise((resolve) => { const m = document.getElementById('customConfirmModal'); if (m) m.remove(); const html = ` <div id="customConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100]"> <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-sm mx-4"> <p class="text-white mb-4 text-sm">${message}</p> <div class="flex justify-end space-x-3"> <button id="customConfirmCancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium text-white">취소</button> <button id="customConfirmOk" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium text-white">삭제</button> </div> </div> </div> `; document.body.insertAdjacentHTML('beforeend', html); const cM = document.getElementById('customConfirmModal'), okB = document.getElementById('customConfirmOk'), canB = document.getElementById('customConfirmCancel'); const rM = () => { if (cM) cM.remove(); }; okB.onclick = () => { rM(); resolve(true); }; canB.onclick = () => { rM(); resolve(false); }; }); }
        async function removeSongFromPlaylist(playlistId, itemIdToRemove) { if (!userId || userId.startsWith('guest-')) return; const pl = userPlaylists.find(p => p.id === playlistId); if (pl) { const items = pl.items.filter(id => id !== itemIdToRemove); try { await updateDoc(doc(db, getUserPlaylistsCollectionPath(userId), playlistId), { items }); showToast('곡 삭제됨.'); if (currentViewingPlaylistId === playlistId && playlistDetailModal && !playlistDetailModal.classList.contains('hidden')) { openPlaylistDetailModal(playlistId); } } catch (e) { console.error("Err removing song:", e); showToast("곡 삭제 오류.", true); } } }
        const likedSongsContainer = document.getElementById('likedSongsContainer'), likedSongsPlaceholder = document.getElementById('likedSongsPlaceholder');
        async function toggleLikeItem(itemId) { if (!userId || userId.startsWith('guest-') || !itemId) return; const ref = doc(db, getUserLikedItemsCollectionPath(userId), itemId); try { if (userLikedItemIds.has(itemId)) { await deleteDoc(ref); showToast('좋아요 취소.'); } else { await setDoc(ref, { likedAt: serverTimestamp(), itemId }); showToast('좋아요 곡 추가.'); } } catch (e) { console.error("Err toggling like:", e); showToast("좋아요 오류.", true); } }
        function renderLikedSongs() { if (!likedSongsContainer || !likedSongsPlaceholder) return; clearContainer(likedSongsContainer, likedSongsPlaceholder); if (!userId || userId.startsWith('guest-')) { if(likedSongsPlaceholder) { likedSongsPlaceholder.classList.remove('hidden'); likedSongsPlaceholder.textContent = "로그인 필요."; } return; } if (userLikedItemIds.size > 0) { if(likedSongsPlaceholder) likedSongsPlaceholder.classList.add('hidden'); Array.from(userLikedItemIds).map(id => allContentData.find(item => item.itemId === id)).filter(item => item).forEach(item => { const div = document.createElement('div'); div.className = 'glassmorphism p-3 rounded-lg flex items-center justify-between hover:bg-purple-700/20'; const img = document.createElement('img'); img.src = getYouTubeThumbnailUrl(item.youtubeId); img.alt = item.title; img.className = 'w-12 h-12 object-cover rounded-md mr-3 cursor-pointer'; img.onerror = function() { this.src = thumbnailErrorPlaceholder; }; img.addEventListener('click', (e) => { e.stopPropagation(); openYoutubeModal(item.youtubeId, item.itemId); }); const textInfo = document.createElement('div'); textInfo.className = 'flex-grow cursor-pointer'; textInfo.addEventListener('click', (e) => { e.stopPropagation(); openYoutubeModal(item.youtubeId, item.itemId); }); const titleH5 = document.createElement('h5'); titleH5.className = 'item-title truncate'; titleH5.textContent = item.title; const artistP = document.createElement('p'); artistP.className = 'item-artist text-gray-400 truncate'; artistP.textContent = item.singerName || item.aiMusicArtist || item.aiTool || 'N/A'; textInfo.append(titleH5, artistP); const actions = document.createElement('div'); actions.className = 'flex items-center'; const unlikeBtn = document.createElement('button'); unlikeBtn.className = 'p-2 text-red-400 hover:text-red-600 ml-2'; unlikeBtn.innerHTML = '<i class="fas fa-heart-broken"></i>'; unlikeBtn.title = "좋아요 취소"; unlikeBtn.addEventListener('click', async (e) => { e.stopPropagation(); await toggleLikeItem(item.itemId); }); actions.appendChild(unlikeBtn); div.append(img, textInfo, actions); likedSongsContainer.appendChild(div); }); } else { if(likedSongsPlaceholder) { likedSongsPlaceholder.classList.remove('hidden'); likedSongsPlaceholder.textContent = "좋아요 곡 없음."; } } }
        const subscribedArtistsContainer = document.getElementById('subscribedArtistsContainer'), subscribedArtistsPlaceholder = document.getElementById('subscribedArtistsPlaceholder');
        async function toggleArtistSubscription(artistName) { if (!userId || userId.startsWith('guest-') || !artistName || artistName === 'N/A') { showToast('로그인 또는 유효한 아티스트 이름 필요.', true); return; } const ref = doc(db, getUserSubscribedArtistsCollectionPath(userId), artistName); try { if (userSubscribedArtists.has(artistName)) { await deleteDoc(ref); showToast(`${artistName} 구독 취소.`); } else { await setDoc(ref, { subscribedAt: serverTimestamp(), artistName }); showToast(`${artistName} 구독함.`); } } catch (e) { console.error("Err toggling sub:", e); showToast("구독 오류.", true); } }
        function renderSubscribedArtists() { if (!subscribedArtistsContainer || !subscribedArtistsPlaceholder) return; clearContainer(subscribedArtistsContainer, subscribedArtistsPlaceholder); if (!userId || userId.startsWith('guest-')) { if(subscribedArtistsPlaceholder) { subscribedArtistsPlaceholder.classList.remove('hidden'); subscribedArtistsPlaceholder.textContent = "로그인 필요."; } return; } if (userSubscribedArtists.size > 0) { if(subscribedArtistsPlaceholder) subscribedArtistsPlaceholder.classList.add('hidden'); Array.from(userSubscribedArtists).sort().forEach(name => { const div = document.createElement('div'); div.className = 'flex items-center justify-between p-2 glassmorphism rounded-md hover:bg-purple-700/20'; const span = document.createElement('span'); span.className = 'text-sm truncate'; span.textContent = name; const btn = document.createElement('button'); btn.className = 'text-xs text-red-400 hover:text-red-600 px-2 py-1 rounded hover:bg-red-700/20 flex-shrink-0'; btn.textContent = '구독 취소'; btn.addEventListener('click', async (e) => { e.stopPropagation(); await toggleArtistSubscription(name); }); div.append(span, btn); subscribedArtistsContainer.appendChild(div); }); } else { if(subscribedArtistsPlaceholder) { subscribedArtistsPlaceholder.classList.remove('hidden'); subscribedArtistsPlaceholder.textContent = "구독 아티스트 없음."; } } }

        function populateCheckboxGroup(containerId, items, groupName, selectedItems = []) {
            const container = document.getElementById(containerId); if (!container) return; container.innerHTML = ''; 
            items.forEach(item => {
                const label = document.createElement('label'); label.className = 'flex items-center space-x-2 p-2 rounded-md hover:bg-purple-700/20 cursor-pointer form-checkbox-label';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.name = groupName; checkbox.value = item;
                checkbox.className = 'form-checkbox text-purple-600 bg-gray-700 border-gray-600 focus:ring-purple-500';
                if (selectedItems.includes(item)) checkbox.checked = true;
                const span = document.createElement('span'); span.textContent = item; span.className = 'text-sm';
                label.append(checkbox, span); container.appendChild(label);
            });
        }
        function populateUploadFormOptions() { populateCheckboxGroup('uploadThemesContainer', predefinedThemes, 'uploadTheme'); populateCheckboxGroup('uploadGenresContainer', predefinedGenres, 'uploadGenre'); populateCheckboxGroup('uploadMoodsContainer', predefinedMoods, 'uploadMood'); updateUploadTagsFromSelections(); }
        function populateEditFormOptions() { populateCheckboxGroup('editThemesContainer', predefinedThemes, 'editTheme'); populateCheckboxGroup('editGenresContainer', predefinedGenres, 'editGenre'); populateCheckboxGroup('editMoodsContainer', predefinedMoods, 'editMood'); updateEditTagsFromSelections(); }
        
        function updateCombinedTags(formPrefix, isManualTagInput = false) {
            const autoGeneratedTags = new Set(); 
            const getEl = (id) => document.getElementById(`${formPrefix}${id}`);
            
            const title = getEl('Title')?.value.trim(); if (title) autoGeneratedTags.add(title);
            const contentType = getEl('ContentType')?.value; if (contentType) autoGeneratedTags.add(contentType); 
            
            const aiArtistEl = getEl('AiMusicArtist'); const aiArtistContainer = getEl('AiMusicArtistContainer');
            if (aiArtistEl && aiArtistContainer && !aiArtistContainer.classList.contains('hidden')) { const val = aiArtistEl.value.trim(); if (val) autoGeneratedTags.add(val); }
            
            const singerEl = getEl('SingerName'); const singerContainer = getEl('SingerNameContainer');
            if (singerEl && singerContainer && !singerContainer.classList.contains('hidden')) { const val = singerEl.value.trim(); if (val) autoGeneratedTags.add(val); }

            const toolEl = getEl('AiTool'); const toolContainer = getEl('AiToolContainer');
            if (toolEl && toolContainer && !toolContainer.classList.contains('hidden')) { const val = toolEl.value.trim(); if (val) autoGeneratedTags.add(val); }

            if (getEl('IsInstrumental')?.checked) autoGeneratedTags.add("Instrumental");

            ['Themes', 'Genres', 'Moods'].forEach(type => {
                Array.from(document.querySelectorAll(`#${formPrefix}${type}Container input:checked`)).forEach(cb => autoGeneratedTags.add(cb.value));
            });

            const tagsInput = getEl('Tags');
            let trulyManualTags = [];
            if (tagsInput) {
                const currentTagsInInput = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
                if (isManualTagInput) { 
                    trulyManualTags = currentTagsInInput;
                } else { 
                    trulyManualTags = currentTagsInInput.filter(tag => !autoGeneratedTags.has(tag));
                }
            }
            
            const finalDisplayTags = [...new Set([...Array.from(autoGeneratedTags), ...trulyManualTags])];
            if (tagsInput) {
                const currentCursorPos = tagsInput.selectionStart;
                const oldValue = tagsInput.value;
                tagsInput.value = finalDisplayTags.join(', ');
                if (isManualTagInput && document.activeElement === tagsInput && oldValue.length === tagsInput.value.length) { 
                     tagsInput.setSelectionRange(currentCursorPos, currentCursorPos);
                }
            }
        }

        function updateUploadTagsFromSelections(isManualTagInput = false) { updateCombinedTags('upload', isManualTagInput); }
        function updateEditTagsFromSelections(isManualTagInput = false) { updateCombinedTags('edit', isManualTagInput); }

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a031a; color: #e0e0e0; overscroll-behavior: none; }
        .neon-accent { color: #8A2BE2; }
        .neon-accent-bg { background-color: #8A2BE2; }
        .sidebar-icon { transition: all 0.3s ease; }
        .sidebar-icon:hover { color: #8A2BE2; transform: scale(1.1); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .glassmorphism { background: rgba(20, 10, 40, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(138, 43, 226, 0.3); }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #8A2BE2; border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #701ebd; }
        .horizontal-scroll::-webkit-scrollbar { height: 6px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background: #8A2BE2; border-radius: 3px;}
        .modal.hidden { display: none; }
        .modal-content { max-height: 80vh; } 

        .item-action-icon-wrapper { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; z-index: 10; }
        .item-action-icon { background-color: rgba(0,0,0,0.7); color: white; border-radius: 50%; cursor: pointer; transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; opacity: 0; display: inline-flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; font-size: 0.875rem; padding: 0.4rem; }
        .item-action-icon:hover { opacity: 1; transform: scale(1.15); }
        
        .like-item-button.fas.fa-heart { color: #ef4444; } 
        .subscribe-artist-icon.fas.fa-heart { color: #ef4444; } 

        .youtube-playable:hover .item-action-icon { opacity: 0.8; }
        .youtube-playable { position: relative; padding-top: 0.5rem; } 
        
        .toast-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; padding: 10px 20px; border-radius: 8px; z-index: 10000; opacity: 0; transition: opacity 0.5s ease-in-out; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4); }
        .toast-message.show { opacity: 1; }

        .item-title { font-size: 0.75rem; font-weight: 500; line-height: 1.2; margin-bottom: 0.125rem; } 
        .item-artist, .item-tags { font-size: 0.65rem; line-height: 1.2; } 
        .item-tags { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: calc(0.65rem * 1.2 * 2);  }
        .item-artist-wrapper { display: flex; align-items: center; margin-bottom: 0.1rem; }


        @media (min-width: 640px) { 
            .item-title { font-size: 0.875rem; } 
            .item-artist, .item-tags { font-size: 0.75rem; }
            .item-tags { min-height: calc(0.75rem * 1.2 * 2); }
            .item-action-icon-wrapper { flex-direction: row; gap: 0.35rem; } 
            .item-action-icon { width: 2.5rem; height: 2.5rem; font-size: 1.125rem; padding: 0.5rem; }

        }
        @media (min-width: 768px) { 
            .youtube-playable { padding-top: 0; } 
        }
        .playlist-card { display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem; transition: background-color 0.2s; }
        .playlist-card:hover { background-color: rgba(138, 43, 226, 0.2); }
        .playlist-cover { width: 4rem; height: 4rem; border-radius: 0.375rem; object-fit: cover; margin-right: 0.75rem; background-color: rgba(138, 43, 226, 0.3); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .playlist-cover i { font-size: 1.5rem; color: rgba(224, 224, 224, 0.7); }
        
        #mobileSidebar.hidden { transform: translateX(-100%); } 
        #mobileSidebarOverlay.hidden { display: none; }

        .thumbnail-image-container { width: 100%; overflow: hidden; border-radius: 0.375rem; aspect-ratio: 16 / 9; margin-bottom: 0.25rem;  } 
        .thumbnail-image { width: 100%; height: 100%; object-fit: cover; } 

        /* Admin upload form styles */
        .form-input, .form-select, .form-textarea {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid rgba(138, 43, 226, 0.5);
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem; /* p-3 */
            color: #e0e0e0;
            width: 100%;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #8A2BE2; /* neon-accent */
            box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.5); /* ring-2 ring-purple-500 */
        }
        .form-label {
            margin-bottom: 0.5rem; /* mb-2 */
            font-weight: 500; /* font-medium */
            display: block;
        }
        .form-checkbox { 
            width: 1.15em; height: 1.15em; /* Adjust size as needed */
            margin-right: 0.5rem;
            border-radius: 0.25rem; /* Slightly rounded corners for checkboxes */
        }
        .form-checkbox:checked {
            background-color: #8A2BE2; /* neon-accent */
            border-color: #8A2BE2;
        }
        .form-checkbox-label { /* For styling the label containing checkbox and text */
            display: inline-flex; /* Aligns checkbox and text nicely */
            align-items: center;
            padding: 0.375rem 0.5rem; /* py-1.5 px-2 */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease;
        }
        .form-checkbox-label:hover {
            background-color: rgba(138, 43, 226, 0.15); /* Slightly lighter hover */
        }
        .checkbox-group-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Responsive columns */
            gap: 0.5rem; /* gap-2 */
            padding: 0.5rem; /* p-2 */
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 0.375rem;
            max-height: 150px; /* Limit height and make scrollable for edit form */
            overflow-y: auto;
        }

    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="desktopSidebar" class="hidden md:flex w-64 glassmorphism p-4 space-y-8 flex-col items-start fixed inset-y-0 left-0 z-30">
        <div id="aionLogoDesktop" class="flex items-center justify-start space-x-3 mb-10 cursor-pointer">
            <svg class="h-14 w-14 neon-accent" viewBox="0 0 24 24" fill="currentColor"> <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            <h1 class="text-4xl font-bold">AION</h1>
        </div>
        <nav class="space-y-4 flex-grow w-full">
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="home"> <i class="fas fa-home fa-fw text-xl sidebar-icon"></i>
                <span class="text-sm">홈</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="library">
                <i class="fas fa-list-alt fa-fw text-xl sidebar-icon"></i>
                <span class="text-sm">플레이 리스트</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="upload" style="display: none;"> <i class="fas fa-upload fa-fw text-xl sidebar-icon"></i>
                <span class="text-sm">업로드</span>
            </a>
        </nav>
        <div class="mt-auto w-full">
             <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="profile">
                <i class="fas fa-user-circle fa-fw text-xl sidebar-icon"></i>
                <span class="text-sm">프로필</span>
            </a>
        </div>
    </aside>

    <div id="mobileSidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    <aside id="mobileSidebar" class="fixed inset-y-0 left-0 w-64 glassmorphism p-4 space-y-8 flex flex-col items-start z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden">
        <div class="flex items-center justify-between w-full mb-6">
            <div id="aionLogoMobile" class="flex items-center space-x-3 cursor-pointer">
                <svg class="h-10 w-10 neon-accent" viewBox="0 0 24 24" fill="currentColor"> <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/> </svg>
                <h1 class="text-2xl font-bold">AION</h1>
            </div>
            <button id="closeMobileSidebarButton" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <nav class="space-y-3 flex-grow w-full">
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="home"> <i class="fas fa-home fa-fw text-lg sidebar-icon"></i>
                <span class="text-sm">홈</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="library">
                <i class="fas fa-list-alt fa-fw text-lg sidebar-icon"></i>
                <span class="text-sm">플레이 리스트</span>
            </a>
            <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="upload" style="display: none;"> <i class="fas fa-upload fa-fw text-lg sidebar-icon"></i>
                <span class="text-sm">업로드</span>
            </a>
        </nav>
        <div class="mt-auto w-full">
             <a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-700/30 transition-colors duration-200" data-section="profile">
                <i class="fas fa-user-circle fa-fw text-lg sidebar-icon"></i>
                <span class="text-sm">프로필</span>
            </a>
        </div>
    </aside>


    <main id="mainContentArea" class="flex-1 md:ml-64 h-screen flex flex-col">
        <header class="p-4 glassmorphism sticky top-0 z-20 flex-shrink-0">
            <div class="flex items-center justify-between">
                <button id="mobileMenuButton" class="text-gray-300 hover:text-white md:hidden mr-3 p-2"> <i class="fas fa-bars text-xl"></i>
                </button>
                <div class="flex-grow">
                     <span id="adminUserIdDisplay" class="text-xs text-red-400 hidden"></span> </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button class="p-2 rounded-full hover:bg-purple-700/30">
                        <i class="fas fa-bell text-lg sm:text-xl"></i>
                    </button>
                    <img src="https://placehold.co/40x40/7F00FF/FFFFFF?text=U" alt="User Avatar" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full cursor-pointer" onclick="document.querySelector('.nav-item[data-section=\'profile\']').click()">
                </div>
            </div>
        </header>

        <div class="flex-grow p-4 sm:p-6 overflow-y-auto scrollable-content pb-6">
            <section id="home" class="content-section"> <div class="mb-8 sm:mb-10">
                    <h3 class="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 flex items-center"><i class="fas fa-chart-line mr-2 neon-accent"></i>AION 차트 <span class="text-xs sm:text-sm text-gray-400 ml-2">(조회수 TOP 10)</span></h3>
                    <div id="aionChartContainer" class="grid grid-cols-2 gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 sm:gap-3">
                        <p id="aionChartPlaceholder" class="text-gray-400 col-span-full text-sm">아직 차트에 표시할 콘텐츠가 없습니다. 영상을 시청하여 조회수를 올려보세요!</p>
                    </div>
                </div>
                <div class="mb-8 sm:mb-10">
                    <h3 class="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 flex items-center"><i class="fas fa-star mr-2 neon-accent"></i>추천 음악</h3>
                    <div id="recommendedMusicContainer" class="grid grid-cols-2 gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 sm:gap-3">
                         <p id="recommendedMusicPlaceholder" class="text-gray-400 col-span-full text-sm">추천된 음악이 없습니다.</p>
                    </div>
                </div>
                <div class="mb-8 sm:mb-10">
                    <h3 class="text-xl sm:text-2xl font-medium mb-3 sm:mb-4 flex items-center"><i class="fas fa-music mr-2 neon-accent"></i>새로운 AI 음악 & MV</h3>
                    <div id="newUploadsContainer" class="grid grid-cols-2 gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 sm:gap-3">
                        <p id="newUploadsPlaceholder" class="text-gray-400 col-span-full text-sm">음악이나 뮤직비디오가 여기에 표시됩니다.</p>
                    </div>
                </div>
            </section>

            <section id="library" class="content-section">
                <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6">플레이 리스트</h2>
                <div class="space-y-8">
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg sm:text-xl font-medium">내 플레이리스트</h3>
                            <button id="createPlaylistButton" class="neon-accent-bg text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg text-xs sm:text-sm font-semibold hover:bg-purple-700 transition-colors">
                                <i class="fas fa-plus mr-1"></i> 새 플레이리스트
                            </button>
                        </div>
                        <div id="myPlaylistsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p id="myPlaylistsPlaceholder" class="text-gray-400 col-span-full text-sm">만든 플레이리스트가 없습니다.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-medium mb-3">좋아요 표시한 곡</h3>
                        <div id="likedSongsContainer" class="space-y-2">
                            <p id="likedSongsPlaceholder" class="text-gray-400 text-sm">아직 좋아요 표시한 곡이 없습니다.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-medium mb-3">구독한 AI 아티스트</h3>
                        <div id="subscribedArtistsContainer" class="space-y-2">
                             <p id="subscribedArtistsPlaceholder" class="text-gray-400 text-sm">아직 구독한 아티스트가 없습니다.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="upload" class="content-section" style="display:none;">
                <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6">새 콘텐츠 업로드</h2>
                <form id="uploadForm" class="glassmorphism p-6 rounded-lg space-y-6 max-w-2xl mx-auto">
                    <div>
                        <label for="uploadYoutubeLink" class="form-label">YouTube 링크 <span class="text-red-500">*</span></label>
                        <input type="url" id="uploadYoutubeLink" name="uploadYoutubeLink" class="form-input" placeholder="https://www.youtube.com/watch?v=..." required>
                        <img id="thumbnailPreview" src="https://placehold.co/320x180/1A0933/4A2270?text=썸네일+미리보기" alt="YouTube Thumbnail Preview" class="mt-2 rounded-lg w-full max-w-xs aspect-video object-cover">
                    </div>
                    <div>
                        <label for="uploadTitle" class="form-label">제목 <span class="text-red-500">*</span></label>
                        <input type="text" id="uploadTitle" name="uploadTitle" class="form-input" required>
                    </div>
                     <div>
                        <label for="uploadContentType" class="form-label">콘텐츠 유형 <span class="text-red-500">*</span></label>
                        <select id="uploadContentType" name="uploadContentType" class="form-select" required>
                            <option value="" disabled selected>유형 선택...</option>
                            <option value="ai-music">AI 생성 음악</option>
                            <option value="ai-mv">AI 생성 뮤직비디오</option>
                            <option value="general-music">일반 음악</option>
                            <option value="general-mv">일반 뮤직비디오</option>
                        </select>
                    </div>
                    
                    <div id="uploadAiMusicArtistContainer" class="hidden space-y-4">
                        <div>
                            <label for="uploadAiMusicArtist" class="form-label">AI 음악 아티스트/모델</label>
                            <input type="text" id="uploadAiMusicArtist" name="uploadAiMusicArtist" class="form-input" placeholder="예: Suno AI, Udio, AIVA">
                        </div>
                    </div>
                    <div id="uploadSingerNameContainer" class="hidden space-y-4">
                        <div>
                            <label for="uploadSingerName" class="form-label">가수 이름 (실제 가수)</label>
                            <input type="text" id="uploadSingerName" name="uploadSingerName" class="form-input" placeholder="예: 아이유, BTS">
                        </div>
                    </div>
                    
                    <div id="uploadAiToolContainer" class="hidden space-y-4">
                        <div>
                            <label for="uploadAiTool" class="form-label">AI MV 생성 도구</label>
                            <input type="text" id="uploadAiTool" name="uploadAiTool" class="form-input" placeholder="예: Runway Gen-2, Kaiber AI">
                        </div>
                    </div>

                    <div>
                        <label for="uploadThemesContainer" class="form-label">주제 (다중 선택 가능)</label>
                        <div id="uploadThemesContainer" class="checkbox-group-container scrollable-content">
                            </div>
                    </div>
                    
                    <div>
                        <label for="uploadGenresContainer" class="form-label">장르 (다중 선택 가능)</label>
                        <div id="uploadGenresContainer" class="checkbox-group-container scrollable-content">
                            </div>
                    </div>

                    <div>
                        <label for="uploadMoodsContainer" class="form-label">분위기 (다중 선택 가능)</label>
                        <div id="uploadMoodsContainer" class="checkbox-group-container scrollable-content">
                            </div>
                    </div>
                    
                    <div>
                        <label for="uploadTags" class="form-label">태그 (자동 완성 및 직접 입력)</label>
                        <input type="text" id="uploadTags" name="uploadTags" class="form-input" placeholder="다른 필드 입력 시 자동 완성, 직접 추가 가능">
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="uploadIsInstrumental" name="uploadIsInstrumental" class="form-checkbox">
                        <label for="uploadIsInstrumental" class="text-sm ml-2">Instrumental (연주곡)</label>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="w-1/2 neon-accent-bg text-white font-semibold py-3 rounded-lg hover:bg-purple-700 transition-colors">업로드</button>
                        <button type="button" id="cancelUploadButton" class="w-1/2 bg-gray-600 text-white font-semibold py-3 rounded-lg hover:bg-gray-700 transition-colors">취소</button>
                    </div>
                </form>
            </section>

            <section id="profile" class="content-section">
                <h2 class="text-2xl sm:text-3xl font-semibold mb-4 sm:mb-6">내 프로필</h2>
                 <div class="glassmorphism p-6 sm:p-8 rounded-lg max-w-2xl mx-auto">
                    <div class="flex flex-col items-center space-y-4">
                        <img src="https://placehold.co/120x120/7F00FF/FFFFFF?text=U" alt="User Avatar" class="w-24 h-24 sm:w-32 sm:h-32 rounded-full border-4 border-purple-500">
                        <h3 id="profileUserName" class="text-xl sm:text-2xl font-semibold">사용자 로딩중...</h3>
                        <p id="profileUserId" class="text-gray-400 text-xs">User ID: 로딩중...</p>
                        <p class="text-gray-400 text-sm">AION 뮤직 플랫폼 사용자입니다.</p>
                        <button class="px-4 py-2 sm:px-6 sm:py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-medium transition-colors text-sm" disabled title="프로필 수정 기능은 현재 지원되지 않습니다.">프로필 수정 (준비중)</button>
                    </div>
                    <div class="mt-8">
                        <h4 class="text-base sm:text-lg font-medium mb-2">계정 상태</h4>
                        <p class="text-gray-400 text-sm">구독 상태: <span class="neon-accent">무료 사용자</span></p>
                        <p class="text-gray-400 text-sm">참고: 이 페이지는 데모용이며 실제 사용자 데이터는 저장되지 않을 수 있습니다.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="youtubeModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[70] hidden">
        <div class="glassmorphism p-1 md:p-2 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 relative">
            <button id="closeYoutubeModalButton" class="absolute -top-3 -right-3 md:top-2 md:right-2 text-white bg-purple-600 hover:bg-purple-800 rounded-full w-8 h-8 flex items-center justify-center text-xl z-10"> × </button>
            <div class="aspect-video">
                <div id="youtubePlayer"></div> {/* iframe 대신 API가 플레이어를 삽입할 div */}
            </div>
        </div>
    </div>
    
    <div id="editItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] hidden p-4">
        <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-2xl modal-content overflow-y-auto scrollable-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">콘텐츠 수정</h3>
                <button id="cancelEditItemButtonInModal" class="text-gray-400 hover:text-white text-2xl">×</button>
            </div>
            <form id="editItemForm" class="space-y-4">
                <div>
                    <label for="editYoutubeLink" class="form-label">YouTube 링크 <span class="text-red-500">*</span></label>
                    <input type="url" id="editYoutubeLink" name="editYoutubeLink" class="form-input" required>
                    <img id="editThumbnailPreview" src="https://placehold.co/320x180/1A0933/4A2270?text=썸네일+미리보기" alt="Edit Thumbnail Preview" class="mt-2 rounded-lg w-full max-w-xs aspect-video object-cover">
                </div>
                <div>
                    <label for="editTitle" class="form-label">제목 <span class="text-red-500">*</span></label>
                    <input type="text" id="editTitle" name="editTitle" class="form-input" required>
                </div>
                 <div>
                    <label for="editContentType" class="form-label">콘텐츠 유형 <span class="text-red-500">*</span></label>
                    <select id="editContentType" name="editContentType" class="form-select" required>
                        <option value="" disabled selected>유형 선택...</option>
                        <option value="ai-music">AI 생성 음악</option>
                        <option value="ai-mv">AI 생성 뮤직비디오</option>
                        <option value="general-music">일반 음악</option>
                        <option value="general-mv">일반 뮤직비디오</option>
                    </select>
                </div>

                <div id="editAiMusicArtistContainer" class="hidden space-y-4">
                    <div>
                        <label for="editAiMusicArtist" class="form-label">AI 음악 아티스트/모델</label>
                        <input type="text" id="editAiMusicArtist" name="editAiMusicArtist" class="form-input">
                    </div>
                </div>
                <div id="editSingerNameContainer" class="hidden space-y-4">
                    <div>
                        <label for="editSingerName" class="form-label">가수 이름 (실제 가수)</label>
                        <input type="text" id="editSingerName" name="editSingerName" class="form-input">
                    </div>
                </div>

                <div id="editAiToolContainer" class="hidden space-y-4">
                    <div>
                        <label for="editAiTool" class="form-label">AI MV 생성 도구</label>
                        <input type="text" id="editAiTool" name="editAiTool" class="form-input">
                    </div>
                </div>

                <div>
                    <label for="editThemesContainer" class="form-label">주제 (다중 선택 가능)</label>
                    <div id="editThemesContainer" class="checkbox-group-container scrollable-content"></div>
                </div>
                <div>
                    <label for="editGenresContainer" class="form-label">장르 (다중 선택 가능)</label>
                    <div id="editGenresContainer" class="checkbox-group-container scrollable-content"></div>
                </div>
                <div>
                    <label for="editMoodsContainer" class="form-label">분위기 (다중 선택 가능)</label>
                    <div id="editMoodsContainer" class="checkbox-group-container scrollable-content"></div>
                </div>
                <div>
                    <label for="editTags" class="form-label">태그 (자동 완성 및 직접 입력)</label>
                    <input type="text" id="editTags" name="editTags" class="form-input">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="editIsInstrumental" name="editIsInstrumental" class="form-checkbox">
                    <label for="editIsInstrumental" class="text-sm ml-2">Instrumental (연주곡)</label>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelEditItemButtonInModalClose" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium">취소</button> 
                    <button type="submit" class="px-4 py-2 neon-accent-bg hover:bg-purple-700 rounded-lg text-sm font-medium">저장</button>
                </div>
            </form>
        </div>
    </div>


    <div id="createPlaylistModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h3 class="text-xl font-semibold mb-4">새 플레이리스트 만들기</h3>
            <input type="text" id="newPlaylistName" placeholder="플레이리스트 이름" class="w-full p-3 rounded-lg bg-black/30 border border-purple-700/50 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4 text-sm text-white">
            <div class="flex justify-end space-x-3">
                <button id="cancelCreatePlaylist" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium text-white">취소</button>
                <button id="confirmCreatePlaylist" class="px-4 py-2 neon-accent-bg hover:bg-purple-700 rounded-lg text-sm font-medium text-white">만들기</button>
            </div>
        </div>
    </div>

    <div id="addToPlaylistModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h3 class="text-xl font-semibold mb-4">플레이리스트에 추가</h3>
            <div id="playlistSelectionContainer" class="space-y-2 mb-4 max-h-60 overflow-y-auto scrollable-content pr-2">
                <p id="playlistSelectionPlaceholder" class="text-gray-400 text-sm">플레이리스트가 없습니다. 먼저 플레이리스트를 만들어주세요.</p>
            </div>
            <input type="text" id="newPlaylistNameInAddModal" placeholder="또는 새 플레이리스트 이름 입력" class="w-full p-3 rounded-lg bg-black/30 border border-purple-700/50 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4 text-sm text-white">
            <div class="flex justify-end space-x-3">
                <button id="cancelAddToPlaylist" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium text-white">취소</button>
                <button id="confirmAddToPlaylist" class="px-4 py-2 neon-accent-bg hover:bg-purple-700 rounded-lg text-sm font-medium text-white">추가</button>
            </div>
        </div>
    </div>

    <div id="playlistDetailModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden p-4">
        <div class="glassmorphism p-6 rounded-lg shadow-xl w-full max-w-2xl modal-content mx-auto overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="playlistDetailName" class="text-2xl font-semibold">플레이리스트 이름</h3>
                <button id="closePlaylistDetailModal" class="text-gray-400 hover:text-white text-2xl">×</button>
            </div>
            <div id="playlistDetailItemsContainer" class="space-y-3 max-h-[calc(80vh-150px)] overflow-y-auto scrollable-content pr-2">
                <p id="playlistDetailPlaceholder" class="text-gray-400 text-sm">이 플레이리스트에 곡이 없습니다.</p>
            </div>
             <div class="mt-4 flex justify-end space-x-2">
                <button id="deletePlaylistButton" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium text-white">플레이리스트 삭제</button>
            </div>
        </div>
    </div>
    
    <div id="toastMessage" class="toast-message"></div>

</body>
</html>
